var ChatWidget=function(){"use strict";var P=Object.defineProperty;var V=(f,m,x)=>m in f?P(f,m,{enumerable:!0,configurable:!0,writable:!0,value:x}):f[m]=x;var r=(f,m,x)=>(V(f,typeof m!="symbol"?m+"":m,x),x);const f="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciICB2aWV3Qm94PSIwIDAgNTAgNTAiIHdpZHRoPSI1MHB4IiBoZWlnaHQ9IjUwcHgiPjxwYXRoIGQ9Ik0gNy43MTg3NSA2LjI4MTI1IEwgNi4yODEyNSA3LjcxODc1IEwgMjMuNTYyNSAyNSBMIDYuMjgxMjUgNDIuMjgxMjUgTCA3LjcxODc1IDQzLjcxODc1IEwgMjUgMjYuNDM3NSBMIDQyLjI4MTI1IDQzLjcxODc1IEwgNDMuNzE4NzUgNDIuMjgxMjUgTCAyNi40Mzc1IDI1IEwgNDMuNzE4NzUgNy43MTg3NSBMIDQyLjI4MTI1IDYuMjgxMjUgTCAyNSAyMy41NjI1IFoiLz48L3N2Zz4=",m="data:image/png;base64,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",x="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAYAAADimHc4AAAACXBIWXMAAAsTAAALEwEAmpwYAAAC3UlEQVR4nO2cMWgUQRhG30XhBAkWcuCBlQraCAGx8kqxESuxtbSTlJZaWmppJaS0TSW2QRsbQYUUBhshNoGAGk5MVg5m8Lrzcv/ezP7/92D62Xm3u/N27w6EEEIIIYQQQgghhPjHe+A+cFKLUoYmjR3gEXCm0DyILiCPfeA5cL70xKIKyGMMvAKul55gVAHTYwu4A/RKTzaqgDy2gXXgVOlJRxWQxy7wBDhbevJRBeRxAGwAV0ofRFQBeRwCm8DN0gcTVcD0UNgVFqCwq0RAk4bCbkEBL4BfBiLGwEvg6ryfEO/MWrgJg/Sc6JvRWbGlsJtPQKafnpx+NBKxrbCbT0Cml7acm0YidiOH3XEETLOWYuy3gYiDiGG3qIDMufQp3jMQcRgp7KwEZFbTdf2r0eXJfdhZC8ispJ3OOyMRbt/YtSVgmlF6ufPHQIS7sFuGgMzFtHg/DUS4eWO3TAEZhV1hARmFXWEBmdBhV4OA0GFXm4BwYVergDBhV7sA92HXFQFuw66LAlyF3ayJfU43sGfAQ+B22lVM9vC1MAAeA98NRBwBr4Fby/oq5iKT3Us3tckn5ynwIO00hpSh38U3dhYTnUfOBeDEEsPuqPawa0tAM+N6+wV4k751MdmN3AOuAaejhV0JAc0CZ4+7sOuSgGFlAm50VcC4o5egH2m+ly0n6P0m3Hi+CXvfhn5Ix1R0G6oQa5lZAiI9itgo8eXhLgoY6WGcj8fR6y3sutydAat6IVOGYa3h5P0MWKs9nDwK6HUpnDwJ6Kdw+tSlcPIgYKDfnJURcMlDOHVRwMhTOHVFwIrXcKpdgPtwqlVAmHCqTUC4cKpBQOhwKilA4VRIgMKpoAD9XU3LNC2PfW/hZE1bC7/jNZyssV549+FkjcWihwonaxZZ+JDhZM1xFj50OFnj/o1T7fzPwutfDlvE/Run2lE4FUbhVJi3wN0l/GhCCCGEEEIIIYQQQgg88xc8fBUjmiJ1QwAAAABJRU5ErkJggg==",g="FMX22",y="https://dev-api.rnsb.ru:843/api",S="wss://dev-api.rnsb.ru:843/ws/obj",L=(o,s={})=>{let e=o;return typeof o=="string"&&(e=new URL(o)),new URL(`${e.origin}${e.pathname}?${new URLSearchParams([...Array.from(e.searchParams.entries()),...Object.entries(s)])}`).href},b=o=>{const s=window.localStorage.getItem(`${g}-widget-${o}-data`);return JSON.parse(s)},M=(o,s)=>{for(const[e,t]of Object.entries(o))t===null||typeof t>"u"||(typeof t=="object"&&!Array.isArray(t)?(s[e]=s[e]||{},M(t,s[e])):s[e]=e==="mountPoint"&&typeof t=="string"?document.querySelector(t):t)},N=o=>{if(JSON.parse(window.sessionStorage.getItem(`${g}-widget-${o}-hist`))===null){const e=[document.referrer,window.location.href];window.sessionStorage.setItem(`${g}-widget-${o}-hist`,JSON.stringify(e))}if(!window[g].histTO){const e=()=>{const t=JSON.parse(window.sessionStorage.getItem(`${g}-widget-${o}-hist`))||[],i=t[t.length-1],n=window.location.href;i!==n&&(t.push(n),window.sessionStorage.setItem(`${g}-widget-${o}-hist`,JSON.stringify(t))),window[g].histTO=setTimeout(e,500)};e()}},B=o=>{window.localStorage.removeItem(`${g}-widget-${o}-data`),window.sessionStorage.removeItem(`${g}-widget-${o}-hist`)},D=(o,s,e)=>{let t;function i(n){const a=n[0];a.target.dataset.visible=a.isIntersecting.toString(),setTimeout(()=>{e.intersectCb&&e.intersectCb(a,t)},200)}t=new IntersectionObserver(i,{root:o,threshold:.5}),t.observe(s)},O=(o,s)=>{new MutationObserver(t=>{t.forEach(i=>{i.addedNodes.forEach(n=>{n.classList.contains("chat-w-msg-row-send")||D(o,n,s)})})}).observe(o,{childList:!0})},v=o=>new Date(o).toLocaleDateString("ru",{month:"long",day:"numeric"}),k=(o,s)=>v(o)===v(s),E={newChat:()=>`${y}/message/newchat/`,messages:(o,s)=>L(`${y}/message/chat/${o}/messages/`,s),settings:o=>`${y}/core/widget/${o}/`,identity:o=>`${y}/account/identity/${o}/`,lead:o=>`${y}/core/lead/${o}/`};class H{constructor(s={}){r(this,"response_number","");r(this,"response_email","");r(this,"contact_types",[{name:"phone",text:"Телефон",on_select_text:"Введите Ваш номер телефона",on_end_text:"Вам поступит звонок с номера<br> {{PHONE}}"},{name:"whatsapp",text:"WhatsApp",on_select_text:"Введите Ваш номер WhatsApp",on_end_text:"Вам поступит звонок с номера {{PHONE}}"},{name:"telegram",text:"Telegram",on_select_text:"Введите Ваш номер Телеграм",on_end_text:"Вам поступит звонок с номера {{PHONE}}"},{name:"viber",text:"Viber",on_select_text:"Введите Ваш номер Вайбер",on_end_text:"Вам поступит звонок с номера {{PHONE}}"},{name:"email",text:"Эл. почта",on_select_text:"Введите Вашу электронную почту",on_end_text:"Вам будет отправлено электронное письмо"}]);r(this,"steps",[{text:"На данный момент все операторы заняты, выберите как мы можем с Вами связаться",wait_input:!0,wait_time:0,buttons:null,info:"Выберите как с Вами связаться"},{text:"{{on_select_text}}",wait_input:!0,wait_time:500,buttons:null,info:"{{on_select_text}}"},{text:"Как к Вам обращаться?",wait_input:!0,wait_time:500,buttons:null,info:"Напишите Ваше имя"},{text:"{{on_end_text}}",wait_input:!1,wait_time:500,buttons:null,info:null}]);r(this,"running",!1);r(this,"exitFn",null);r(this,"currStep",-1);r(this,"currHandle",null);r(this,"contacts",{name:null,type:null,number:null});this.response_number=s.response_number,this.response_email=s.response_email,this.contact_types=(s.contact_types||this.contact_types).map(e=>(e.on_end_text=e.on_end_text.replace(/\{\{PHONE}}/g,this.response_number).replace(/\{\{EMAIL}}/g,this.response_email),e)),s.steps&&s.steps.forEach((e,t)=>{e&&(this.steps[t]=e)}),this.steps[0].buttons=this._genContactButtons()}getNextStep(){return this.currStep+=1,this.steps[this.currStep]}stop(){this.running&&this.exitFn&&(this.running=!1,this.exitFn("stopped"),this.exitFn=null)}_genContactButtons(){return this.contact_types.map(s=>({text:s.text,name:s.name}))}}class R{constructor(s,e){r(this,"settings",{id:null,data_type:"core__widget",created_at:null,updated_at:null,title:null,site:null,type:0,data:{chat_settings:{mount_point:document.querySelector("#chat-widget"),visible:!1,buttons:[{text:"Узнать статус заказа",command:"get_order_status"}],logo:{src:"",width:"0",height:"0"},text:{header:"Всегда рады ответить на Ваши вопросы!",welcome_message:"Здравствуйте!"},toggle_button_visible:{initial:!0,show_with_chat:!1,hide_with_chat:!1},initial_show_delay:0,history_limit:20,no_answer_limit:2e4},contact_dialog:{response_number:"8-804-333-08-05",response_email:"email@em.ru"}},source:window.FMX22.chat.source,company:null,hotel:null,operator:null,agent:null});r(this,"extraButtons",null);r(this,"dialog",null);r(this,"_token",null);r(this,"_connecting",!1);r(this,"_chatInitialized",!1);r(this,"_chatShown",!1);r(this,"_chatId",null);r(this,"_messages",[]);r(this,"_messagesProxy",null);r(this,"_sendCB",null);r(this,"_defaultPlaceholder","Напишите что-нибудь");r(this,"_ws",null);r(this,"_root",null);r(this,"_error",{});r(this,"_messageDate",{prev:null,curr:Date.now()});r(this,"_historyEnd",!1);r(this,"_isSenderActive",!1);r(this,"_wrapper",null);r(this,"_inner",null);r(this,"_container",null);r(this,"_chatToggleButton",null);r(this,"_openImg",null);r(this,"_closeImg",null);r(this,"_chatMsgsCont",null);r(this,"_chatInput",null);r(this,"_sendButton",null);r(this,"_errCont",null);r(this,"_buttonsEl",null);r(this,"_lastMsgEl",null);r(this,"_loadingChatHistory",!1);r(this,"_addingChatHistory",!1);r(this,"_chatHistoryOffset",0);r(this,"_chatInitialTO",null);r(this,"_chatAnswerTO",null);r(this,"_chatNoAnswerCbList",[]);const t=this;N(s.id);const i=b(s.id);if(i&&i.token&&(this._token=i.token),M(s,t.settings),this.extraButtons=e,this._messagesProxy=new Proxy(this._messages,{set(n,a,u){if(a==="length")return!0;if(Array.isArray(u)){n.push(...u.reverse());const p=new DocumentFragment;u.forEach((_,h)=>{const{messageEl:C,dateEl:l}=t._addMessage(_);t._lastMsgEl=C,l&&p.append(l),p.append(t._lastMsgEl)}),t._chatMsgsCont.prepend(p)}else{!n.length&&!t._chatInitialized&&t._chatMsgsCont.prepend(t._createDayRow()),n[a]=u;const{childEl:p}=u,{messageEl:_,dateEl:h}=t._addMessage(u);t._lastMsgEl=_,p&&t._lastMsgEl.append(p),h&&t._chatMsgsCont.append(h),t._chatMsgsCont.append(t._lastMsgEl),t._lastMsgEl.scrollIntoView({behavior:"smooth"})}return!0}}),!this.settings.data.chat_settings.mount_point)throw new Error("ChatWidget: Элемент не найден по селектору указанному в chat_settings.mount_point");this._root=this.settings.data.chat_settings.mount_point.attachShadow({mode:"open"}),Promise.resolve().then(()=>j).then(n=>{this._root.append(n.style),this._create()}),this.settings.data.chat_settings.initial_show_delay>0&&(this._chatInitialTO=setTimeout(()=>{this.show()},this.settings.data.chat_settings.initial_show_delay)),this._chatNoAnswerCbList.push(async()=>{if(b(s.id))try{({}).status!=2&&await t.contactsDialog()}catch(a){this._error.message={title:a.message||a,text:"",orig:a.origError||a,result:a.result}}}),i&&i.chat&&(this._chatId=i.chat,this._setupWS(i),this._chatInitialized=!0)}_createDayRow(){const s=this._addDateRow();return s.insertAdjacentHTML("afterbegin",`
              <span>${v(this._messageDate.curr)}</span>
            `),s}_conditionalAddDayRow(){if(!k(this._messageDate.prev,this._messageDate.curr)&&this._messageDate.prev!==null&&new Date(this._messageDate.prev).getTime()<new Date(this._messageDate.curr).getTime())return this._createDayRow()}_addRow(s){const{direction:e,temp:t,data:i}=s,n=document.createElement("div");return n.classList.add("chat-w-msg-row"),i&&i.id&&(n.dataset.id=i.id,n.dataset.read=(i.read===!0).toString()),e==="send"&&n.classList.add("chat-w-msg-row-send"),t&&n.classList.add("temp"),n}_addDateRow(){const s=document.createElement("div");return s.classList.add("chat-w-date-row"),s}_addMessage(s){const{type:e,data:t}=s;this._messageDate.curr=t.created_at||Date.now();const i=this._conditionalAddDayRow();if(this._messageDate.prev=this._messageDate.curr,e==="text")return{messageEl:this._addTextMessage(s),dateEl:i};if(e==="button")return{messageEl:this._addBtnMessage(s),dateEl:i}}_addTextMessage(s){const{direction:e,text:t,data:i}=s,n=new Date(this._messageDate.curr).toLocaleTimeString(void 0,{timeStyle:"short"}),a=this._addRow(s);return a.insertAdjacentHTML("afterbegin",`
         <p class="chat-w-msg ${e==="send"?"chat-w-msg-send":""}">
           ${t}
           <br>
           <span class="chat-w-msg_time${e==="send"?"_send":""}">${n}</span>
         </p>
        `),a}_addBtnMessage(s){const{direction:e,text:t,data:i}=s,n=new Date(this._messageDate.curr).toLocaleTimeString().slice(0,-3),a=this._addRow(s);return a.insertAdjacentHTML("afterbegin",`
        <span class="chat-w-btn">
          ${t}
        </span>
         <span class="chat-w-btn_time${e==="send"?"_send":""}">${n}</span>
         `),a}_addActionBtn(s,e,t){return s.insertAdjacentHTML("beforeend",`<span class="chat-w-btn-act" data-name="${e}">${t}</span>`),s}_createNoteEl(s){const e=document.createElement("div");return e.classList.add("chat-w-msg-note"),e.insertAdjacentHTML("afterbegin",s),e}_create(){const s=this;this._wrapper=document.createElement("div"),this._wrapper.classList.add("chat-w"),this._inner=document.createElement("div"),this._inner.classList.add("chat-w-inn"),this._inner.insertAdjacentHTML("afterbegin",`
         <div class="chat-w-toggle-btn${this.settings.data.chat_settings.toggle_button_visible.initial?"":" hidden"}">
           <img src="${m}" class="chat-w-open-img" alt="Открыть Чат">
           <img src="${f}" class="chat-w-close-img hidden" alt="Закрыть Чат">
         </div>
    `),this._container=document.createElement("div"),this._container.classList.add("chat-w-cont","chat-w-cont-close"),this._container.insertAdjacentHTML("afterbegin",`
      <div class="chat-w-cont-inn">
        <div class="chat-w-header">
          <div class="chat-w-header-ava-cont">
             ${this.settings.data.chat_settings.logo&&this.settings.data.chat_settings.logo.src?`<img src="${this.settings.data.chat_settings.logo.src}" alt="Лого" style="width:${this.settings.data.chat_settings.logo.width};height:${this.settings.data.chat_settings.logo.height}">`:""}
          </div>
          <span class="chat-w-header-title">${this.settings.data.chat_settings.text.header}</span>
        </div>
        <div class="chat-w-err hidden"><div></div></div>
        <div class="chat-w-msgs invisible"></div>
        <div class="chat-w-btns"></div>
        <div class="chat-w-msg-cont">
           <input type="text" placeholder="${this._defaultPlaceholder}">
           <div class="chat-w-msg-send-cont">
              <img src="${x}" alt="Отправить сообщение">
           </div>
        </div>
      </div>
    `),this._container.addEventListener("transitionstart",e=>{e.propertyName==="scale"&&this._inner.classList.add("chat-w-cont-transition")}),this._container.addEventListener("transitionend",e=>{e.propertyName==="scale"&&(this._inner.classList.remove("chat-w-cont-transition"),this._chatToggleButton.dataset.chatVisible=`${this.settings.data.chat_settings.visible}`)}),this._inner.append(this._container),this._wrapper.append(this._inner),this._root.append(this._wrapper),this._chatToggleButton=this._wrapper.querySelector(".chat-w-toggle-btn"),this._openImg=this._wrapper.querySelector(".chat-w-open-img"),this._closeImg=this._wrapper.querySelector(".chat-w-close-img"),this._chatMsgsCont=this._wrapper.querySelector(".chat-w-msgs"),this._buttonsEl=this._wrapper.querySelector(".chat-w-btns"),this._sendButton=this._wrapper.querySelector(".chat-w-msg-send-cont"),this._chatInput=this._wrapper.querySelector(".chat-w-msg-cont>input"),this._errCont=this._wrapper.querySelector(".chat-w-err");for(const e of this.settings.data.chat_settings.buttons){const t=document.createElement("span");t.textContent=e.text,t.classList.add("chat-w-btn"),t.addEventListener("click",()=>{this._send(e.text,{command:e.command})}),this._buttonsEl.append(t)}if(this._chatToggleButton.addEventListener("click",()=>{this.toggle()}),this._sendButton.addEventListener("click",()=>{this._send()}),this._chatInput.addEventListener("keyup",e=>{e.key==="Enter"&&this._send()}),Object.defineProperty(this._error,"message",{set(e){e?(s._errCont.innerHTML=`
                    <div>
                      <p>${e.title}</p>
                      <span>${e.text}</span>
                    </div>
                    `,s._errCont.classList.remove("hidden"),e.orig&&console.error(e.orig)):s._errCont.classList.add("hidden")}}),this.settings.data.chat_settings.visible&&this.show(),this.extraButtons){const e=new DocumentFragment;this.extraButtons.forEach(t=>{const i=document.createElement("div");i.classList.add("chat-w-extra-btn"),i.style.backgroundColor=t.color||"unset",i.insertAdjacentHTML("afterbegin",`<img src="${t.imgSrc}" style="${t.imgStyle||""}" alt="${t.title||""}">`),t.action&&i.addEventListener("click",t.action),e.append(i)}),this._inner.append(e)}O(this._chatMsgsCont,{intersectCb:(e,t)=>{s._notifyRead(e,t)}})}_getCurrentURL(){return window.location.href}_updateChatData(s){try{const e=b(this.settings.id);this._token||(this._token=s.token),localStorage.setItem(`${g}-widget-${this.settings.id}-data`,JSON.stringify({...e,...s}))}catch(e){const t=new Error("Ошибка сохранения локальных данных виджета");throw t.origError=e,t}}async _onShowChat(){if(!this._chatShown){const s=b(this.settings.id);let e;if(s&&s.chat){try{e=await this._getMessages(s.chat)}catch(t){this._error.message={title:t.message||t,text:"",orig:t.origError||t,result:t.result};return}this._messagesProxy.push(e),setTimeout(()=>{this._lastMsgEl&&this._lastMsgEl.scrollIntoView(),this._chatMsgsCont.addEventListener("scroll",async()=>{if(this._chatMsgsCont.scrollTop===0&&!this._addingChatHistory){if(this._addingChatHistory=!0,e.length)try{e=await this._getMessages(s.chat)}catch(t){this._error.message={title:t.message||t,text:"",orig:t.origError||t,result:t.result};return}e.length&&(this._lastMsgEl.scrollIntoView(),this._messagesProxy.push(e),this._lastMsgEl.scrollIntoView()),setTimeout(()=>{this._addingChatHistory=!1},300)}else this._chatMsgsCont.scrollTop===0&&this._addingChatHistory&&e.length&&this._lastMsgEl.scrollIntoView()})},100)}else setTimeout(()=>{this._messagesProxy.push({type:"text",direction:"receive",text:this.settings.data.chat_settings.text.welcome_message,data:{}})},800);this._chatShown=!0}setTimeout(()=>{this._lastMsgEl&&this._lastMsgEl.scrollIntoView({behavior:"smooth"})},300)}async _initializeChat(s){const e=this;let t={},i;try{i=await this._newChat(s.text)}catch(n){throw this._chatInitialized=!1,n}try{t=this._token?{chat:i.data.chat,lead:i.data.lead}:i.data,this._updateChatData(t),this._chatId=t.chat}catch(n){throw this._chatInitialized=!1,n}await this._setupWS(t),this._messagesProxy.push(s),this.settings.data.chat_settings.no_answer_limit>0&&(this._chatAnswerTO=setTimeout(()=>{e._chatNoAnswerCbList.forEach(n=>{setTimeout(n,0)})},this.settings.data.chat_settings.no_answer_limit)),this._chatInitialized=!0}async _setupWS(s){this._connecting=!0;try{const e=`${S}/${this._token.key}/`;this._ws=await new WebSocket(e),this._ws.addEventListener("error",()=>{const t=new Error("Соединение не может быть установлено");this._error.message={title:t.message,text:"",orig:null}}),this._ws.addEventListener("message",t=>{const i=JSON.parse(t.data);if(i.type==="message_read"){const{id:a}=i.data,u=this._chatMsgsCont.querySelector(`[data-id="${a}"]`);u&&(u.dataset.read=`${!0}`);return}if(i.type==="chat"&&i.data.sender===this._token.identity){if(this._isSenderActive){const a=this._messagesProxy[this._messagesProxy.length-1];a.data=i.data,delete a.temp,this._lastMsgEl.classList.remove("temp"),this._lastMsgEl.dataset.id=i.data.id,this._isSenderActive=!1}else{const a={type:"text",direction:"send",text:i.data.content,data:i.data};this._messagesProxy.push(a)}return}if(i.type!=="chat"&&!i.data.content)return;const n={type:"text",direction:"receive",text:i.data.content,data:i.data};this._messagesProxy.push(n),clearTimeout(this._chatAnswerTO)}),this._ws.addEventListener("open",()=>{this._ws.send(JSON.stringify({type:"subscribe",data_type:"messaging__chat",object_id:s.chat,window_handler:`chat-${s.chat}-lead-${s.lead}`}))}),this._connecting=!1}catch(e){this._connecting=!1,this._chatInitialized=!1;const t=new Error("Соединение не может быть установлено");throw t.origError=e,t}}async _send(s="",{command:e}={}){const t=this;if(!this._chatInput.value&&!s)return;this._error.message=null,clearTimeout(t._chatAnswerTO),this._isSenderActive=!0;const i=s||this._chatInput.value;let n={},a="text";const u="send",p=!0;this._chatInput.value="",e?(n={content:s,command:e,data_type:"messaging__message"},a="button"):(n={content:i,data_type:"messaging__message"},a="text");const _={type:a,direction:u,text:i,temp:p,data:n};if(this.dialog&&this.dialog.running&&this.dialog.currHandle&&(_.data[this.dialog.currHandle]=_.data.content),this._chatInitialized)try{if(_.data.chat=this._chatId,this._ws.send(JSON.stringify({type:"create_chat_message",data:_.data})),this._ws.readyState!==1)throw new Error("Соединение не установлено");this._messagesProxy.push(_)}catch(h){this._error.message={title:h.message||h,text:"",orig:h.origError||h,result:h.result};return}else try{await this._initializeChat(_)}catch(h){this._error.message={title:h.message||h,text:"",orig:h.origError||h,result:h.result};return}this._sendCB&&this._sendCB(_),t._buttonsEl.classList.add("hidden")}async _newChat(s){let e,t,i;try{e=JSON.stringify({text:s,url:this._getCurrentURL(),widget:this.settings.id,source:this.settings.source})}catch(n){const a=new Error("Неправильный формат body для newchat");throw a.origError=n,a}try{t=await fetch(E.newChat(),{method:"POST",headers:{"Content-Type":"application/json;charset=utf-8",Authorization:this._token?this._token.key:window[g].webKey},body:e})}catch(n){const a=new Error("Ошибка при создании чата");throw a.origError=n,a}try{i=await t.json()}catch{const a=new Error("Ошибка при создании чата");throw a.origError=t.statusText,a}if(t.ok)return i;{const n=new Error(JSON.stringify(i));throw n.result=i,n.origError=t.statusText,n}}async _getLead(s){let e,t;try{e=await fetch(E.lead(s),{method:"GET",headers:{"Content-Type":"application/json;charset=utf-8",Authorization:this._token.key}})}catch(i){throw i}try{t=await e.json()}catch{throw new Error(e.statusText)}if(e.ok)return t.data;{const i=new Error(JSON.stringify(t));throw i.result=t,i.origError=e.statusText,i}}async _getMessages(s){if(this._historyEnd)return[];let e,t;const i={limit:this.settings.data.chat_settings.history_limit,offset:this._chatHistoryOffset};try{e=await fetch(E.messages(s,i),{method:"GET",headers:{"Content-Type":"application/json;charset=utf-8",Authorization:this._token.key}})}catch(n){throw n}try{t=await e.json()}catch{throw new Error(e.statusText)}if(e.ok)return this._historyEnd=t.data.next===null,this._historyEnd&&setTimeout(()=>{this._chatMsgsCont.prepend(this._createDayRow())},100),this._chatHistoryOffset=this._chatHistoryOffset+this.settings.data.chat_settings.history_limit,t.data.results.map(n=>({type:"text",direction:n.sender===this._token.identity?"send":"receive",text:n.content,data:n}));{const n=new Error(JSON.stringify(t));throw n.result=t,n.origError=e.statusText,n}}_notifyRead(s,e){if(this.settings.data.chat_settings.visible!==!1&&s.target.dataset.visible==="true"&&s.target.dataset.read!=="true"){const t=this._messages.find(i=>i.data.id==s.target.dataset.id);t&&t.data.id&&(this._ws.send(JSON.stringify({type:"message_read",data:t.data})),s.target.dataset.read="true",s.target.removeAttribute("data-visible"),e.unobserve(s.target))}}static async getSettings(s){const e=window.sessionStorage.getItem(`${g}-widget-${s}-settings`);let t,i;try{if(e)return JSON.parse(e)}catch(n){const a=new Error("Неправильный формат настроек виджета");throw a.origError=n,a}try{t=await fetch(E.settings(s),{method:"GET",headers:{"Content-Type":"application/json;charset=utf-8",Authorization:window[g].webKey}})}catch(n){const a=new Error("Ошибка запроса настроек виджета");throw a.origError=n,a}try{i=await t.json()}catch{const a=new Error("Ошибка запроса настроек виджета");throw a.origError=t.statusText,a}if(t.ok){const n=i?i.data:{};return window.sessionStorage.setItem(`${g}-widget-${s}-settings`,JSON.stringify(n)),n}else{const n=new Error(JSON.stringify(i));throw n.result=i,n.origError=t.statusText,n}}static async getIdentity(s){const e=b(s);if(!e||!e.token||!e.token.identity)return null;let t,i;try{t=await fetch(E.identity(e.token.identity),{method:"GET",headers:{"Content-Type":"application/json;charset=utf-8",Authorization:e.token.key}})}catch(n){const a=new Error("Ошибка запроса identity");throw a.origError=n,a}try{i=await t.json()}catch{const a=new Error("Ошибка запроса identity");throw a.origError=t.statusText,a}if(t.ok)return i?i.data:{};{const n=new Error(JSON.stringify(i));throw n.result=i,n.origError=t.statusText,n.response=t,n}}static clearData(s){B(s)}hide(){this._container.classList.remove("chat-w-cont-open"),this._openImg.classList.remove("hidden"),this._closeImg.classList.add("hidden"),this._container.classList.add("chat-w-cont-close"),this._chatMsgsCont.classList.add("invisible"),this.settings.data.chat_settings.visible=!1,this.settings.data.chat_settings.toggle_button_visible.hide_with_chat&&this._chatToggleButton.classList.add("hidden")}show(){clearTimeout(this._chatInitialTO),this._container.classList.remove("chat-w-cont-close"),this._closeImg.classList.remove("hidden"),this._openImg.classList.add("hidden"),this._container.classList.add("chat-w-cont-open"),this._chatMsgsCont.classList.remove("invisible"),this.settings.data.chat_settings.toggle_button_visible.show_with_chat&&this._chatToggleButton.classList.remove("hidden"),this.settings.data.chat_settings.visible=!0,this._onShowChat()}toggle(){this.settings.data.chat_settings.visible?this.hide():this.show()}async contactsDialog(s){const e=this,t=new H(s||e.settings.data.contact_dialog);this.dialog=t;const i=t.getNextStep(),n=()=>new Promise((l,I)=>{t.exitFn=l,clearTimeout(e._chatAnswerTO),setTimeout(()=>{if(this._messagesProxy.push({type:"text",direction:"receive",text:i.text,data:{}}),i.buttons){const d=e._addRow({direction:"receive"}),w=document.createElement("div");w.classList.add("chat-w-msg-row__cont"),i.buttons.forEach(c=>{e._addActionBtn(w,c.name,c.text)}),d.append(w),e._chatMsgsCont.append(d),d.scrollIntoView({behavior:"smooth"}),d.addEventListener("click",c=>{t.contacts.type=c.target.dataset.name,e._chatInput.value=c.target.textContent,t.currHandle="CONTACT_TYPE",e._send(),d.classList.add("inactive")})}i.wait_input?(i.info&&(e._chatInput.placeholder=i.info),e._sendCB=()=>{e._sendCB=null,t.currHandle=null,l()}):l()},i.wait_time)}),a=t.getNextStep(),u=()=>new Promise((l,I)=>{t.exitFn=l,t.currHandle="CONTACT_NUMBER",clearTimeout(e._chatAnswerTO),setTimeout(()=>{let d,w;if(a.text.includes("{{on_select_text}}")){const c=t.contact_types.find(A=>A.name===t.contacts.type);if(!c)return t.stop(),l();d=a.text.replace("{{on_select_text}}",c.on_select_text),w=a.info.replace("{{on_select_text}}",c.on_select_text)}else d=a.text,w=a.info;this._messagesProxy.push({type:"text",direction:"receive",text:d,data:{}}),a.wait_input?(a.info&&(e._chatInput.placeholder=w),e._sendCB=c=>{t.contacts.number=c.data.content,e._sendCB=null,t.currHandle=null,l()}):l()},a.wait_time)}),p=t.getNextStep(),_=()=>new Promise((l,I)=>{t.exitFn=l,t.currHandle="NAME",clearTimeout(e._chatAnswerTO),setTimeout(()=>{this._messagesProxy.push({type:"text",direction:"receive",text:p.text,data:{}}),p.wait_input?(p.info&&(e._chatInput.placeholder=p.info),e._sendCB=d=>{t.contacts.name=d.data.content,e._sendCB=null,t.currHandle=null,l()}):l()},p.wait_time)}),h=t.getNextStep(),C=()=>new Promise((l,I)=>{t.exitFn=l,clearTimeout(e._chatAnswerTO),setTimeout(()=>{let d;if(h.text.includes("{{on_end_text}}")){const c=t.contact_types.find(A=>A.name===t.contacts.type);if(!c)return t.stop(),l();d=h.text.replace("{{on_end_text}}",c.on_end_text)}else d=h.text;const w=e._createNoteEl('<span class="link">Изменить контактные данные</span>');w.addEventListener("click",()=>{e.dialog&&e.dialog.stop();const c=JSON.parse(JSON.stringify(e.settings.data.contact_dialog))||{},A={text:"Выберите как мы можем с Вами связаться",wait_input:!0,wait_time:0,buttons:null,info:"Выберите как с Вами связаться"};c.steps=c.steps||[],c.steps[0]?c.steps[0].text="Выберите как мы можем с Вами связаться":c.steps.push(A),e.contactsDialog(c)}),this._messagesProxy.push({type:"text",direction:"receive",text:d,data:{},childEl:w}),l()},h.wait_time)});t.running=!0,t.running&&await n(),t.running&&await u(),t.running&&await _(),t.running&&await C(),e._chatInput.placeholder=e._defaultPlaceholder,t.running=!1,this.dialog=null}}const T=document.createElement("style");T.textContent=`@charset "UTF-8";.chat-w{position:fixed;bottom:10px;right:10px;z-index:99999}.chat-w *{box-sizing:border-box;line-height:16px;font-size:15px;font-family:Arial,Helvetica,sans-serif}.chat-w-inn{position:relative;display:flex;justify-content:flex-end;flex-direction:row-reverse;gap:8px}.chat-w-toggle-btn{width:80px;height:80px;border-radius:40px;background-color:#1e90ff;cursor:pointer;display:flex;justify-content:center;align-items:center}.chat-w-toggle-btn img{width:65%;filter:invert(1)}.chat-w-toggle-btn img.chat-w-close-img{width:55%}.chat-w-extra-btn{width:80px;height:80px;border-radius:40px;cursor:pointer;display:flex;justify-content:center;align-items:center}.chat-w-cont{width:400px;height:720px;position:absolute;bottom:100px;right:10px;transform-origin:bottom right}.chat-w-cont-open{transition:scale .3s ease-out,opacity .5s ease .1s;opacity:1;scale:1}.chat-w-cont-close{transition:scale .5s ease-in,opacity .3s ease;opacity:0;scale:0}.chat-w-cont-inn{width:100%;height:100%;display:flex;flex-direction:column;border-radius:4px;box-shadow:0 6px 6px #00000005,0 8px 24px #0000001f;background:white}.chat-w-header{width:100%;min-height:20%;flex-shrink:0;background-color:#1e90ff;border-radius:4px 4px 0 0;display:flex;flex-direction:column;justify-content:center;align-items:center}.chat-w-header-ava-cont{display:flex}.chat-w-header-title{font-weight:700;color:#fff;padding:13px 0}.chat-w-msgs{flex-grow:1;padding:15px;display:flex;flex-direction:column;gap:14px;overflow:auto;background-color:#fff;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='12' viewBox='0 0 20 12'%3E%3Cg fill-rule='evenodd'%3E%3Cg id='charlie-brown' fill='%2391d0f5' fill-opacity='0.24'%3E%3Cpath d='M9.8 12L0 2.2V.8l10 10 10-10v1.4L10.2 12h-.4zm-4 0L0 6.2V4.8L7.2 12H5.8zm8.4 0L20 6.2V4.8L12.8 12h1.4zM9.8 0l.2.2.2-.2h-.4zm-4 0L10 4.2 14.2 0h-1.4L10 2.8 7.2 0H5.8z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");transition:opacity .3s ease .35s}.chat-w-btns{padding:15px 15px 0;display:flex;gap:8px;flex-shrink:0;flex-wrap:wrap}.chat-w-msg-send-cont{height:100%;width:40px;cursor:pointer;display:flex;justify-content:center;align-items:center}.chat-w-msg-send-cont img{width:100%;filter:invert(50%) sepia(100%) hue-rotate(180deg) saturate(300%)}.chat-w-msg{max-width:75%;margin:0;padding:10px;background-color:#e3e4e9;color:#212b36;box-shadow:1px 1px 2px #aaa;border-radius:12px}.chat-w-msg-send{background-color:#4a85dd;color:#fff}.chat-w-msg-cont{display:flex;align-items:center;flex-shrink:0;gap:7.5px;padding:7.5px;height:60px}.chat-w-msg-cont input{width:100%;height:80%;border:1px solid #d8dcde;border-radius:20px;padding-left:15px;color:#212b36}.chat-w-msg-cont input:focus{outline:unset!important;border-color:#1e90ff}.chat-w-msg-cont input:focus-visible{outline:unset!important;border-color:#1e90ff}.chat-w-msg-row{display:flex;align-items:flex-start;flex-direction:column;transition:opacity ease .2s}.chat-w-msg-row-send{align-items:flex-end}.chat-w-msg-row-send .chat-w-btn{pointer-events:none;max-width:75%}.chat-w-msg-row__cont{display:flex;flex-wrap:wrap;gap:16px}.chat-w-msg-note{padding:0 10px;margin-top:3px}.chat-w-msg-note .link{font-size:13px}.chat-w-msg_time,.chat-w-btn_time_send,.chat-w-btn_time,.chat-w-msg_time_send{display:inline-block;width:100%;position:relative;left:-3px;bottom:-5px;color:#212b3680;font-size:13px}.chat-w-msg_time_send{text-align:right;left:unset;right:-3px;color:#e3e4e9cc}.chat-w-btn{color:#36c;background:rgba(255,255,255,.6);padding:9px 14px;border-radius:18px;border:1px solid #3366CC;display:inline-block;cursor:pointer;flex-shrink:0;user-select:none}.chat-w-btn:hover{color:#1e90ff;border-color:#1e90ff}.chat-w-btn_time_send{text-align:right;left:unset;right:-3px}.chat-w-btn-act{color:#36c;background:#e3e4e9;padding:9px 14px;border-radius:8px;display:inline-block;cursor:pointer;flex-shrink:0;user-select:none;box-shadow:0 2px 4px #33333373;transition:all .15s ease}.chat-w-btn-act:hover{color:#fff;background:dodgerblue;box-shadow:0 3px 6px #3333338c}.chat-w-err{display:flex;align-items:center;background-color:#f801261a;margin:15px;border-radius:4px}.chat-w-err:before{content:"!";display:flex;justify-content:center;align-items:center;flex-shrink:0;margin:15px;color:#fff;font-weight:700;font-size:18px;width:30px;height:30px;border-radius:15px;background-color:#f80126e6}.chat-w-err div{height:100%;font-size:13px;display:flex;flex-direction:column;justify-content:center}.chat-w-err p{margin:0;padding:4px 0;font-weight:700;color:#f80126e6;text-align:left}.chat-w-err span{display:block;line-height:13px}.chat-w-date-row{display:flex;justify-content:center;align-items:center}.chat-w-date-row span{padding:13px 15px;border-radius:24px;background:rgba(33,43,54,.5);color:#fff}.link{color:#36c;text-decoration:none;cursor:pointer}.link:hover{text-decoration:underline}.hidden{display:none!important}.invisible{opacity:0}.inactive{pointer-events:none}.err{color:red}.temp{opacity:.6}[data-read=true] .chat-w-msg_time_send:after,[data-read=true] .chat-w-btn_time_send:after{position:relative;bottom:-2px;content:"✓✓  ";padding:0 12px 0 6px;font-size:18px;letter-spacing:-22px}@media (max-height: 850px){.chat-w-cont{height:84vh}}@media (max-width: 680px) and (orientation: portrait),(max-height: 720px) and (orientation: landscape){.chat-w-cont{position:fixed;right:0;bottom:0;width:100vw;height:100vh;z-index:100000}.chat-w-cont-transition .chat-w-toggle-btn{opacity:0}.chat-w-header{border-radius:0}.chat-w-toggle-btn[data-chat-visible=true]{position:fixed;top:0;right:0;z-index:100001;background:none;width:56px;height:56px}}
`;const j=Object.freeze(Object.defineProperty({__proto__:null,style:T},Symbol.toStringTag,{value:"Module"}));return R}();
