var ChatWidget=function(){"use strict";var B=Object.defineProperty;var I=(c,h,l)=>h in c?B(c,h,{enumerable:!0,configurable:!0,writable:!0,value:l}):c[h]=l;var s=(c,h,l)=>(I(c,typeof h!="symbol"?h+"":h,l),l);const c="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciICB2aWV3Qm94PSIwIDAgNTAgNTAiIHdpZHRoPSI1MHB4IiBoZWlnaHQ9IjUwcHgiPjxwYXRoIGQ9Ik0gNy43MTg3NSA2LjI4MTI1IEwgNi4yODEyNSA3LjcxODc1IEwgMjMuNTYyNSAyNSBMIDYuMjgxMjUgNDIuMjgxMjUgTCA3LjcxODc1IDQzLjcxODc1IEwgMjUgMjYuNDM3NSBMIDQyLjI4MTI1IDQzLjcxODc1IEwgNDMuNzE4NzUgNDIuMjgxMjUgTCAyNi40Mzc1IDI1IEwgNDMuNzE4NzUgNy43MTg3NSBMIDQyLjI4MTI1IDYuMjgxMjUgTCAyNSAyMy41NjI1IFoiLz48L3N2Zz4=",h="data:image/png;base64,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",l="data:image/png;base64,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",x="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAYAAADimHc4AAAACXBIWXMAAAsTAAALEwEAmpwYAAAC3UlEQVR4nO2cMWgUQRhG30XhBAkWcuCBlQraCAGx8kqxESuxtbSTlJZaWmppJaS0TSW2QRsbQYUUBhshNoGAGk5MVg5m8Lrzcv/ezP7/92D62Xm3u/N27w6EEEIIIYQQQgghhPjHe+A+cFKLUoYmjR3gEXCm0DyILiCPfeA5cL70xKIKyGMMvAKul55gVAHTYwu4A/RKTzaqgDy2gXXgVOlJRxWQxy7wBDhbevJRBeRxAGwAV0ofRFQBeRwCm8DN0gcTVcD0UNgVFqCwq0RAk4bCbkEBL4BfBiLGwEvg6ryfEO/MWrgJg/Sc6JvRWbGlsJtPQKafnpx+NBKxrbCbT0Cml7acm0YidiOH3XEETLOWYuy3gYiDiGG3qIDMufQp3jMQcRgp7KwEZFbTdf2r0eXJfdhZC8ispJ3OOyMRbt/YtSVgmlF6ufPHQIS7sFuGgMzFtHg/DUS4eWO3TAEZhV1hARmFXWEBmdBhV4OA0GFXm4BwYVergDBhV7sA92HXFQFuw66LAlyF3ayJfU43sGfAQ+B22lVM9vC1MAAeA98NRBwBr4Fby/oq5iKT3Us3tckn5ynwIO00hpSh38U3dhYTnUfOBeDEEsPuqPawa0tAM+N6+wV4k751MdmN3AOuAaejhV0JAc0CZ4+7sOuSgGFlAm50VcC4o5egH2m+ly0n6P0m3Hi+CXvfhn5Ix1R0G6oQa5lZAiI9itgo8eXhLgoY6WGcj8fR6y3sutydAat6IVOGYa3h5P0MWKs9nDwK6HUpnDwJ6Kdw+tSlcPIgYKDfnJURcMlDOHVRwMhTOHVFwIrXcKpdgPtwqlVAmHCqTUC4cKpBQOhwKilA4VRIgMKpoAD9XU3LNC2PfW/hZE1bC7/jNZyssV549+FkjcWihwonaxZZ+JDhZM1xFj50OFnj/o1T7fzPwutfDlvE/Run2lE4FUbhVJi3wN0l/GhCCCGEEEIIIYQQQgg88xc8fBUjmiJ1QwAAAABJRU5ErkJggg==";class w{constructor(t){s(this,"wrapper",null);s(this,"shown",!1);s(this,"_main",null);s(this,"_visible",!1);s(this,"_settings",null);s(this,"_name",null);s(this,"_closeCB",null);s(this,"_closeBtn",null);s(this,"_container",null);s(this,"_phoneInput",null);s(this,"_phoneWarn",null);s(this,"_sendPhoneBtn",null);s(this,"_feedbackContainer",null);s(this,"_content",null);this._settings=t.settings,this._name=t.name,this._api=t.api||{},this._closeCB=t.closeCB,this._main=t.main,this._content={ordercall:`
      <h1>${this._settings.text.h1}</h1>
      <h2>${this._settings.text.h2}</h2>
      <div class="chat-w-popup-${this._name}__row">
        <input type="text" placeholder="+7" value="+7">
        <button>${this._settings.text.phoneButton}</button>
      </div>
      <div class="chat-w-popup-${this._name}__row warn hidden">
         <span>${this._settings.text.phoneError}</span>
      </div>
    `,promo:`
      <h1>${this._settings.text.h1}</h1>
      <h2>${this._settings.text.h2}</h2>
      <div class="chat-w-popup-${this._name}__row">
        <input type="text" placeholder="+7" value="+7">
      </div>
      <div class="chat-w-popup-${this._name}__row warn hidden">
         <span>${this._settings.text.phoneError}</span>
      </div>
      <div class="chat-w-popup-${this._name}__row">
         <button>${this._settings.text.phoneButton}</button>
      </div>
    `},this._create(),this._closeBtn=this.wrapper.querySelector(".chat-w-popup__close"),this._container=this.wrapper.querySelector(`.chat-w-popup-${this._name}`),this._feedbackContainer=this.wrapper.querySelector(`.chat-w-popup-${this._name}-feedback`),this._sendPhoneBtn=this.wrapper.querySelector("button"),this._phoneInput=this.wrapper.querySelector("input"),this._phoneWarn=this.wrapper.querySelector(`.chat-w-popup-${this._name}__row.warn`),this._sendPhoneBtn.addEventListener("click",()=>{this._sendPhone(this._phoneInput.value)}),this._phoneInput.addEventListener("keyup",e=>{e.key==="Enter"&&this._sendPhone(this._phoneInput.value)}),this._phoneInput.addEventListener("focus",()=>{this._phoneWarn.classList.add("hidden")}),this._phoneInput.addEventListener("click",()=>{this._phoneWarn.classList.add("hidden")}),this._closeBtn.addEventListener("click",()=>{this.hide()}),this._main.addEventListener("backcall-error",e=>{this._visible&&this._phoneWarn.classList.remove("hidden")})}_create(){this.wrapper=document.createElement("div"),this.wrapper.classList.add("chat-w-popup-wrap","hidden"),this.wrapper.insertAdjacentHTML("afterbegin",`
           <div class="chat-w-popup">
              <div class="chat-w-popup__close">
                <img src="${c}" alt="Закрыть">
              </div>
              <div class="chat-w-popup-${this._name}">
                 ${this._content[this._name]}
              </div>
              <div class="chat-w-popup-${this._name}-feedback"></div>
           </div>
        `)}_checkPhone(t){return/^\+?\d{6,}$/.test(t)}async _sendPhone(t){if(this._checkPhone(t)){const e=this;this._main.dispatchEvent(new CustomEvent("backcall",{detail:{phone:t,cb:()=>{e._feedbackContainer.innerHTML=`<h1>${e._settings.text.feedback.replace(/{%\s*PHONE\s*%}/ig,t)}</h1>`,e._feedbackContainer.classList.remove("hidden"),e._container.classList.add("hidden")}}}))}else this._phoneWarn.classList.remove("hidden")}hide(){this._visible=!1,this.wrapper.classList.add("hidden"),this._closeCB&&this._closeCB()}show(){this._visible=!0,this.wrapper.classList.remove("hidden"),this.shown=!0}toggle(){this._visible?this.hide():this.show()}}const m="FMX22",g="http://dev-api.rnsb.ru:88/api",b="ws://dev-api.rnsb.ru:88/ws/obj",A=(p,t={})=>{let e=p;return typeof p=="string"&&(e=new URL(p)),new URL(`${e.origin}${e.pathname}?${new URLSearchParams([...Array.from(e.searchParams.entries()),...Object.entries(t)])}`).href},u={newChat:()=>`${g}/message/newchat/`,messages:(p,t)=>A(`${g}/message/chat/${p}/messages/`,t),backCall:()=>`${g}/telephony/backcall/`};class y{constructor(t){s(this,"_token",null);s(this,"_webmasterKey",null);s(this,"_mountPoint",null);s(this,"_popupOrderCallSettings",{show:{initial:0,chatNoAnswer:0,onExit:0},text:{h1:"У Вас остались вопросы?",h2:"Закажите бесплатный обратный звонок",phoneButton:"Жду звонка!",phoneError:"Проверьте, что Вы ввели правильный номер!",feedback:"Мы перезвоним Вам в ближайшее время на номер {%PHONE%}"},toggleButtonVisible:{initial:!0,showAfterClose:!0}});s(this,"_popupPromoSettings",{show:{initial:0,chatNoAnswer:0,onExit:0},text:{h1:"10% СКИДКА для всей семьи",h2:"Оставьте свой номер телефона чтобы получить 10% СКИДКУ на поездку для всей семьи!",phoneButton:"ПОЛУЧИТЬ СКИДКУ!",phoneError:"Проверьте, что Вы ввели правильный номер!",feedback:"Мы перезвоним Вам в ближайшее время на номер {%PHONE%}"}});s(this,"_chatSettings",{visible:!1,buttons:[],logo:{src:"",width:"0",height:"0"},text:{header:"Всегда рады ответить на Ваши вопросы!",welcomeMessage:"Здравствуйте!"},toggleButtonVisible:{initial:!0,showWithChat:!1,hideWithChat:!1},initialShowDelay:0,historyLimit:20});s(this,"_connecting",!1);s(this,"_chatInitialized",!1);s(this,"_chatShown",!1);s(this,"_chatId",null);s(this,"_messages",[]);s(this,"_messagesProxy",null);s(this,"_ws",null);s(this,"_root",null);s(this,"_error",{});s(this,"_wrapper",null);s(this,"_inner",null);s(this,"_container",null);s(this,"_chatToggleButton",null);s(this,"_openImg",null);s(this,"_closeImg",null);s(this,"_orderCallToggleButton",null);s(this,"_chatMsgsCont",null);s(this,"_chatInput",null);s(this,"_sendButton",null);s(this,"_errCont",null);s(this,"_buttonsEl",null);s(this,"_lastMsgEl",null);s(this,"_loadingChatHistory",!1);s(this,"_addingChatHistory",!1);s(this,"_chatHistoryOffset",0);s(this,"_chatInitialTO",null);s(this,"_popupInitialTO",null);s(this,"_chatAnswerTO",null);s(this,"_setOnExitTO",null);s(this,"popupOrderCall",null);s(this,"popupPromo",null);const e=this,i=this._getChatData();i&&i.token&&(this._token=i.token),this._webmasterKey=t.webmasterKey,this._mountPoint=document.querySelector(t.mountPoint||"body"),t.chatSettings&&(t.chatSettings.visible!==void 0&&(this._chatSettings.visible=t.chatSettings.visible),t.chatSettings.buttons!==void 0&&(this._chatSettings.buttons=t.chatSettings.buttons),t.chatSettings.logo!==void 0&&(this._chatSettings.logo=t.chatSettings.logo),t.chatSettings.initialShowDelay!==void 0&&(this._chatSettings.initialShowDelay=t.chatSettings.initialShowDelay),t.chatSettings.historyLimit!==void 0&&(this._chatSettings.historyLimit=t.chatSettings.historyLimit),this._chatSettings.text={...this._chatSettings.text,...t.chatSettings.text||{}},this._chatSettings.toggleButtonVisible={...this._chatSettings.toggleButtonVisible,...t.chatSettings.toggleButtonVisible||{}}),t.popupOrderCallSettings&&(this._popupOrderCallSettings.toggleButtonVisible={...this._popupOrderCallSettings.toggleButtonVisible,...t.popupOrderCallSettings.toggleButtonVisible||{}},this._popupOrderCallSettings.show={...this._popupOrderCallSettings.show,...t.popupOrderCallSettings.show||{}},this._popupOrderCallSettings.text={...this._popupOrderCallSettings.text,...t.popupOrderCallSettings.text||{}}),t.popupPromoSettings&&(this._popupPromoSettings.show={...this._popupPromoSettings.show,...t.popupPromoSettings.show||{}},this._popupPromoSettings.text={...this._popupPromoSettings.text,...t.popupPromoSettings.text||{}}),this._messagesProxy=new Proxy(this._messages,{set(n,o,a){if(o==="length")return!0;if(Array.isArray(a)){n.push(...a);const r=new DocumentFragment;a.forEach((d,f)=>{const{type:E,direction:S,text:v}=d;e._lastMsgEl=e._addMessage(E,S,v),r.append(e._lastMsgEl)}),e._chatMsgsCont.prepend(r)}else{n[o]=a;const{type:r,direction:d,text:f}=a;e._lastMsgEl=e._addMessage(r,d,f),e._chatMsgsCont.append(e._lastMsgEl),e._lastMsgEl.scrollIntoView({behavior:"smooth"})}return!0}}),this._root=this._mountPoint.attachShadow({mode:"open"}),Promise.resolve().then(()=>C).then(n=>{this._root.append(n.style),this._create()}),this._chatSettings.initialShowDelay>0&&(this._chatInitialTO=setTimeout(()=>{this.show()},this._chatSettings.initialShowDelay)),this._popupOrderCallSettings.show.initial>0&&(clearTimeout(this._popupInitialTO),this._popupInitialTO=setTimeout(()=>{this.popupOrderCall.shown||this.popupOrderCall.show()},this._popupOrderCallSettings.show.initial)),this._popupOrderCallSettings.show.onExit>0&&(clearTimeout(this._setOnExitTO),this._setOnExitTO=setTimeout(()=>{const n=()=>{e.popupOrderCall.shown||e.popupOrderCall.show()};document.addEventListener("mouseout",this._newOnExitHandler(n))},this._popupOrderCallSettings.show.onExit)),this._popupPromoSettings.show.initial>0&&(clearTimeout(this._popupInitialTO),this._popupInitialTO=setTimeout(()=>{this.popupPromo.shown||this.popupPromo.show()},this._popupPromoSettings.show.initial)),this._popupPromoSettings.show.onExit>0&&(clearTimeout(this._setOnExitTO),this._setOnExitTO=setTimeout(()=>{const n=()=>{e.popupPromo.shown||e.popupPromo.show()};document.addEventListener("mouseout",this._newOnExitHandler(n))},this._popupPromoSettings.show.onExit))}_addRow(t){const e=document.createElement("div");return e.classList.add("chat-w-msg-row"),t==="send"&&e.classList.add("chat-w-msg-row-send"),e}_addMessage(t,e,i){if(t==="text")return this._addTextMessage(e,i);if(t==="button")return this._addBtnMessage(e,i)}_addTextMessage(t,e){const i=this._addRow(t);return i.insertAdjacentHTML("afterbegin",`<p class="chat-w-msg ${t==="send"?"chat-w-msg-send":""}">${e}</p>`),i}_addBtnMessage(t,e){const i=this._addRow(t);return i.insertAdjacentHTML("afterbegin",`<span class="chat-w-btn">${e}</span>`),i}_newOnExitHandler(t){const e=i=>{!i.relatedTarget&&i.clientY<10&&(document.removeEventListener("mouseout",e),t())};return e}_create(){const t=this;this._wrapper=document.createElement("div"),this._wrapper.classList.add("chat-w"),this._inner=document.createElement("div"),this._inner.classList.add("chat-w-inn"),this._inner.insertAdjacentHTML("afterbegin",`
         <div class="chat-w-call-btn${this._popupOrderCallSettings.toggleButtonVisible.initial?"":" hidden"}">
           <img src="${l}" alt="Обратный звонок">
         </div>
         <div class="chat-w-toggle-btn${this._chatSettings.toggleButtonVisible.initial?"":" hidden"}">
           <img src="${h}" class="chat-w-open-img" alt="Открыть Чат">
           <img src="${c}" class="chat-w-close-img hidden" alt="Закрыть Чат">
         </div>
    `),this._container=document.createElement("div"),this._container.classList.add("chat-w-cont","chat-w-cont-close"),this._container.insertAdjacentHTML("afterbegin",`
      <div class="chat-w-cont-inn">
        <div class="chat-w-header">
          <div class="chat-w-header-ava-cont">
             ${this._chatSettings.logo&&this._chatSettings.logo.src?`<img src="${this._chatSettings.logo.src}" alt="Лого" style="width:${this._chatSettings.logo.width};height:${this._chatSettings.logo.height}">`:""}
          </div>
          <span class="chat-w-header-title">${this._chatSettings.text.header}</span>
        </div>
        <div class="chat-w-err hidden"><div></div></div>
        <div class="chat-w-msgs"></div>
        <div class="chat-w-btns"></div>
        <div class="chat-w-msg-cont">
           <input type="text" placeholder="Напишите что-нибудь">
           <div class="chat-w-msg-send-cont">
              <img src="${x}" alt="Отправить сообщение">
           </div>
        </div>
      </div>
    `),this._inner.append(this._container),this.popupOrderCall=new w({name:"ordercall",settings:this._popupOrderCallSettings,closeCB:this._popupOrderCallSettings.toggleButtonVisible.showAfterClose?()=>{t._orderCallToggleButton.classList.remove("hidden")}:null,main:t._wrapper}),this.popupPromo=new w({name:"promo",settings:this._popupPromoSettings,main:t._wrapper}),this._wrapper.append(this._inner),this._wrapper.append(this.popupOrderCall.wrapper),this._wrapper.append(this.popupPromo.wrapper),this._root.append(this._wrapper),this._chatToggleButton=this._wrapper.querySelector(".chat-w-toggle-btn"),this._orderCallToggleButton=this._wrapper.querySelector(".chat-w-call-btn"),this._openImg=this._wrapper.querySelector(".chat-w-open-img"),this._closeImg=this._wrapper.querySelector(".chat-w-close-img"),this._chatMsgsCont=this._wrapper.querySelector(".chat-w-msgs"),this._buttonsEl=this._wrapper.querySelector(".chat-w-btns"),this._sendButton=this._wrapper.querySelector(".chat-w-msg-send-cont"),this._chatInput=this._wrapper.querySelector(".chat-w-msg-cont>input"),this._errCont=this._wrapper.querySelector(".chat-w-err");for(const e of this._chatSettings.buttons){const i=document.createElement("span");i.textContent=e.text,i.classList.add("chat-w-btn"),i.addEventListener("click",()=>{this._send(e.text,{command:e.command})}),this._buttonsEl.append(i)}this._chatToggleButton.addEventListener("click",()=>{this.toggle()}),this._sendButton.addEventListener("click",()=>{this._send()}),this._chatInput.addEventListener("keyup",e=>{e.key==="Enter"&&this._send()}),this._orderCallToggleButton.addEventListener("click",()=>{this.popupOrderCall.toggle()}),Object.defineProperty(this._error,"message",{set(e){e?(t._errCont.innerHTML=`
                  <div>
                    <p>${e.title}</p>
                    <span>${e.text}</span>
                  </div>
                  `,t._errCont.classList.remove("hidden")):t._errCont.classList.add("hidden")}}),this._chatSettings.visible&&this.show(),this._wrapper.addEventListener("backcall",async e=>{const i=await this._backCall(e.detail.phone);if(i){e.detail.cb&&e.detail.cb();const n=i.data,o=this._token?{phone:e.detail.phone}:{token:n,phone:e.detail.phone};this._updateChatData(o)}})}_getCurrentURL(){return window.location.href}_updateChatData(t){try{const e=this._getChatData();this._token||(this._token=t.token),localStorage.setItem(`${m}-chat-data`,JSON.stringify({...e,...t}))}catch(e){console.error(e)}}_getChatData(){try{const t=localStorage.getItem(`${m}-chat-data`);return JSON.parse(t)}catch(t){console.error(t)}}async _onShowChat(){if(!this._chatShown){const t=this._getChatData();if(t){const e=await this._getMessages(t.chat);this._messagesProxy.push(e),setTimeout(()=>{this._lastMsgEl.scrollIntoView(),this._chatMsgsCont.addEventListener("scroll",async()=>{if(this._chatMsgsCont.scrollTop===0&&!this._addingChatHistory){this._addingChatHistory=!0,this._lastMsgEl.scrollIntoView();const i=await this._getMessages(t.chat);this._messagesProxy.push(i),this._lastMsgEl.scrollIntoView(),setTimeout(()=>{this._addingChatHistory=!1},300)}else this._chatMsgsCont.scrollTop===0&&this._addingChatHistory&&this._lastMsgEl.scrollIntoView()})},100)}else setTimeout(()=>{this._messagesProxy.push({type:"text",direction:"receive",text:this._chatSettings.text.welcomeMessage,data:{}})},800);this._chatShown=!0}}async _initializeChat(t){this._connecting=!0;try{const e=this._getChatData();let i={};if(!e||!e.chat){const o=await this._newChat(t.text);if(o&&!o.data)throw new Error(o==null?void 0:o.detail);const{chat:a,lead:r}=o.data;i=this._token?{chat:a,lead:r}:o.data,this._updateChatData(i)}else i=e;this._chatId=i.chat;const n=`${b}/${this._token.key}/`;this._ws=await new WebSocket(n),this._ws.addEventListener("error",()=>{this._error.message={title:"Соединение не может быть установлено",text:""}}),this._ws.addEventListener("message",o=>{const a=JSON.parse(o.data);if(a.type!=="chat")return;const r={type:"text",direction:"receive",text:a.data.content,data:a.data};this._messagesProxy.push(r),clearTimeout(this._chatAnswerTO)}),this._ws.addEventListener("open",()=>{this._ws.send(JSON.stringify({type:"subscribe",data_type:"messaging__chat",object_id:i.chat,window_handler:`chat-${i.chat}-lead-${i.lead}`})),this._ws.send(JSON.stringify({type:"subscribe",data_type:"messaging__message",object_id:i.chat,window_handler:`chat-${i.chat}-lead-${i.lead}`}))}),this._messagesProxy.push(t),this._chatInitialized=!0}catch(e){this._chatInitialized=!1,console.error(e),this._error.message={title:e.message,text:""}}finally{this._connecting=!1}}async _send(t="",{command:e}={}){if(!this._chatInput.value&&!t)return;const i=t||this._chatInput.value;let n={},o="text";const a="send";this._chatInput.value="",e?(n={command:e,data_type:"messaging__message",sender:this._token.identity},o="button"):(n={chat:this._chatId,content:i,data_type:"messaging__message",sender:this._token.identity},o="text");const r={type:o,direction:a,text:i,data:n};if(!this._chatInitialized)await this._initializeChat(r);else try{if(this._ws.send(JSON.stringify({type:"chat",data:n})),this._ws.readyState!==1)throw new Error("Соединение не может быть установлено");this._messagesProxy.push(r)}catch(d){this._error.message={title:d.message,text:""},console.error(d);return}this._popupOrderCallSettings.show.chatNoAnswer>0&&(clearTimeout(this._chatAnswerTO),this._chatAnswerTO=setTimeout(()=>{this.popupOrderCall.shown||this.popupOrderCall.show()},this._popupOrderCallSettings.show.chatNoAnswer)),this._popupPromoSettings.show.chatNoAnswer>0&&(clearTimeout(this._chatAnswerTO),this._chatAnswerTO=setTimeout(()=>{this.popupPromo.shown||this.popupPromo.show()},this._popupPromoSettings.show.chatNoAnswer))}async _newChat(t){var i;return(await fetch(u.newChat(),{method:"POST",headers:{"Content-Type":"application/json;charset=utf-8",Authorization:((i=this._token)==null?void 0:i.key)||this._webmasterKey},body:JSON.stringify({text:t,url:this._getCurrentURL()})})).json()}async _backCall(t){var n;let e={},i=null;try{if(e=await fetch(u.backCall(),{method:"POST",headers:{"Content-Type":"application/json;charset=utf-8",Authorization:((n=this._token)==null?void 0:n.key)||this._webmasterKey},body:JSON.stringify({phone:t,url:this._getCurrentURL()})}),i=await e.json(),e.ok)return i;{const o=Array.isArray(i)?i.join():i.errors.join();throw new Error(o)}}catch(o){const a=i?o.message:e.statusText;this._wrapper.dispatchEvent(new CustomEvent("backcall-error",{detail:{message:a},bubbles:!0})),console.error(a)}}async _getMessages(t){var i;const e={limit:this._chatSettings.historyLimit,offset:this._chatHistoryOffset};try{const n=await fetch(u.messages(t,e),{method:"GET",headers:{"Content-Type":"application/json;charset=utf-8",Authorization:((i=this._token)==null?void 0:i.key)||this._webmasterKey}}),o=await n.json();if(n.ok)return this._chatHistoryOffset=this._chatHistoryOffset+this._chatSettings.historyLimit,o.data.results.map(a=>({type:"text",direction:a.sender===this._token.identity?"send":"receive",text:a.content,data:a}));throw new Error((o==null?void 0:o.detail)||n.statusText)}catch(n){this._error.message={title:n.message,text:""},console.error(n)}}hide(){this._container.classList.remove("chat-w-cont-open"),this._openImg.classList.remove("hidden"),this._container.classList.add("chat-w-cont-close"),this._closeImg.classList.add("hidden"),this._chatSettings.visible=!1,this._chatSettings.toggleButtonVisible.hideWithChat&&this._chatToggleButton.classList.add("hidden")}show(){clearTimeout(this._chatInitialTO),this._container.classList.remove("chat-w-cont-close"),this._closeImg.classList.remove("hidden"),this._container.classList.add("chat-w-cont-open"),this._openImg.classList.add("hidden"),this._chatSettings.toggleButtonVisible.showWithChat&&this._chatToggleButton.classList.remove("hidden"),this._chatSettings.visible=!0,this._onShowChat()}toggle(){this._chatSettings.visible?this.hide():this.show()}}const _=document.createElement("style");_.textContent=`.chat-w{position:fixed;bottom:10px;right:10px;z-index:9999;font-family:Arial,Helvetica,sans-serif;font-size:15px}.chat-w-inn{position:relative;display:flex;justify-content:flex-end;gap:.5rem}.chat-w-toggle-btn{width:80px;height:80px;border-radius:40px;background-color:#1e90ff;cursor:pointer;display:flex;justify-content:center;align-items:center}.chat-w-toggle-btn img{width:65%;filter:invert(1)}.chat-w-toggle-btn img.chat-w-close-img{width:55%}.chat-w-call-btn{width:80px;height:80px;border-radius:40px;background-color:#ff8f1f;cursor:pointer;display:flex;justify-content:center;align-items:center}.chat-w-call-btn img{width:60%;filter:invert(1);padding-top:5px;padding-right:5px}.chat-w-cont{width:100vw;height:100vh;max-width:400px;max-height:720px;position:absolute;bottom:100px;right:10px;transform-origin:bottom right}.chat-w-cont-open{transition:scale .3s ease-out,opacity .5s ease .1s;opacity:1;scale:1}.chat-w-cont-close{transition:scale .5s ease-in,opacity .3s ease;opacity:0;scale:0}.chat-w-cont-inn{width:100%;height:100%;display:flex;flex-direction:column;border-radius:4px;box-shadow:0 6px 6px #00000005,0 8px 24px #0000001f;background:white}.chat-w-header{width:100%;min-height:20%;flex-shrink:0;background-color:#1e90ff;border-radius:4px 4px 0 0;display:flex;flex-direction:column;justify-content:center;align-items:center}.chat-w-header-ava-cont{display:flex}.chat-w-header-title{font-weight:700;color:#fff;padding:.8rem 0}.chat-w-msgs{flex-grow:1;padding:15px;display:flex;flex-direction:column;gap:14px;overflow:auto;background-color:#fff;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='12' viewBox='0 0 20 12'%3E%3Cg fill-rule='evenodd'%3E%3Cg id='charlie-brown' fill='%2391d0f5' fill-opacity='0.24'%3E%3Cpath d='M9.8 12L0 2.2V.8l10 10 10-10v1.4L10.2 12h-.4zm-4 0L0 6.2V4.8L7.2 12H5.8zm8.4 0L20 6.2V4.8L12.8 12h1.4zM9.8 0l.2.2.2-.2h-.4zm-4 0L10 4.2 14.2 0h-1.4L10 2.8 7.2 0H5.8z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")}.chat-w-btns{padding:15px 15px 0;display:flex;gap:8px;flex-shrink:0;flex-wrap:wrap}.chat-w-msg-send-cont{height:100%;width:40px;cursor:pointer;display:flex;justify-content:center;align-items:center}.chat-w-msg-send-cont img{width:100%;filter:invert(50%) sepia(100%) hue-rotate(180deg) saturate(300%)}.chat-w-msg{max-width:75%;margin:0;padding:10px;background-color:#e3e4e9;color:#212b36;box-shadow:1px 1px 2px #aaa;border-radius:12px}.chat-w-msg-send{background-color:#4a85dd;color:#fff}.chat-w-msg-cont{display:flex;align-items:center;flex-shrink:0;gap:7.5px;padding:7.5px;height:60px}.chat-w-msg-cont input{width:100%;height:80%;border:1px solid #d8dcde;border-radius:20px;padding-left:15px;color:#212b36}.chat-w-msg-cont input:focus{outline:unset!important;border-color:#1e90ff}.chat-w-msg-cont input:focus-visible{outline:unset!important;border-color:#1e90ff}.chat-w-msg-row{display:flex;justify-content:flex-start}.chat-w-msg-row-send{justify-content:flex-end}.chat-w-btn{color:#36c;background:rgba(255,255,255,.6);padding:9px 14px;border-radius:18px;border:1px solid #3366CC;box-sizing:border-box;display:inline-block;cursor:pointer;flex-shrink:0;user-select:none}.chat-w-btn:hover{color:#1e90ff;border-color:#1e90ff}.chat-w-err{display:flex;align-items:center;background-color:#f801261a;margin:15px;border-radius:4px}.chat-w-err:before{content:"!";display:flex;justify-content:center;align-items:center;flex-shrink:0;margin:15px;color:#fff;font-weight:700;font-size:1.2rem;width:30px;height:30px;border-radius:15px;background-color:#f80126e6}.chat-w-err div{height:100%;font-size:.8125rem;display:flex;flex-direction:column;justify-content:center}.chat-w-err p{margin:0;padding:.25rem 0;font-weight:700;color:#f80126e6;text-align:left}.chat-w-err span{display:block;line-height:.8125rem}.hidden{display:none!important}.warn{color:red}.chat-w-popup-wrap{position:fixed;top:0;left:0;right:0;bottom:0;display:flex;justify-content:center;align-items:center;margin:auto;background-color:#00000054;z-index:10000000000}.chat-w-popup{width:700px;min-height:345px;height:fit-content;background-color:#fff;border-radius:10px;box-sizing:border-box;padding:40px 20px 20px;position:relative}.chat-w-popup__close{position:absolute;top:15px;right:15px;width:20px;height:20px;cursor:pointer;z-index:1}.chat-w-popup__close img{width:100%;height:auto}.chat-w-popup-ordercall{color:#333;font-family:Arial,Helvetica,sans-serif;font-size:15px}.chat-w-popup-ordercall h1{font-size:1.75rem;text-align:center}.chat-w-popup-ordercall h2{font-size:1.375rem;text-align:center}.chat-w-popup-ordercall__row{display:flex;justify-content:center;align-items:flex-end;flex-wrap:wrap}.chat-w-popup-ordercall input{display:inline-block;border-radius:8px;padding:6px 15px;margin-bottom:10px;font-size:18px;font-style:italic;color:#333;border:2px solid #ccc;background-color:#fff;height:52px;width:250px;top:2px;box-sizing:border-box}.chat-w-popup-ordercall input:focus{outline:unset!important;border-color:#1e90ff}.chat-w-popup-ordercall input:focus-visible{outline:unset!important;border-color:#1e90ff}.chat-w-popup-ordercall button{height:52px;padding:10px 30px;margin-bottom:10px;margin-left:10px;border-radius:8px;color:#fff;border-color:#ff8f1f;font-size:1.25rem;font-weight:700;box-sizing:border-box;cursor:pointer;background-color:#ff8f1f;user-select:none;box-shadow:0 4px 8px #333333a6;transition:all .1s ease}.chat-w-popup-ordercall button:active{box-shadow:0 2px 4px #333333a6;transform:scale(.98)}.chat-w-popup-ordercall-feedback{color:#333;font-family:Arial,Helvetica,sans-serif;display:flex;justify-content:center;align-items:center}.chat-w-popup-ordercall-feedback h1{font-size:1.5rem;line-height:2.5rem;text-align:center;margin:3rem 0}.chat-w-popup-promo{padding:0 4rem}.chat-w-popup-promo h1{font-size:2rem;text-align:center;color:#1e90ff}.chat-w-popup-promo h2{font-size:1.125rem;text-align:center;color:#4a4a4a}.chat-w-popup-promo input{display:inline-block;font-size:22px;color:#4a4a4a;border-width:0 0 2px 0;border-style:solid;border-color:#ccc;background-color:#fff;text-align:center;width:250px;box-sizing:border-box}.chat-w-popup-promo input:focus{outline:unset!important;border-color:#1e90ff}.chat-w-popup-promo input:focus-visible{outline:unset!important;border-color:#1e90ff}.chat-w-popup-promo__row{display:flex;justify-content:center;align-items:flex-end;padding:30px 0}.chat-w-popup-promo__row.warn{padding:0}.chat-w-popup-promo button{width:250px;box-sizing:border-box;padding:15px;background:none;border:3px solid dodgerblue;border-radius:3px;font-size:1.2rem;font-weight:700;color:#1e90ff;cursor:pointer;transition:all .1s ease;margin-bottom:1rem}.chat-w-popup-promo button:hover{box-shadow:0 4px 8px #333333a6;background-color:#1e90ff;color:#fff}.chat-w-popup-promo button:active{box-shadow:0 2px 4px #333333a6;transform:scale(.98)}.chat-w-popup-promo-feedback{color:#333;font-family:Arial,Helvetica,sans-serif;display:flex;justify-content:center;align-items:center}.chat-w-popup-promo-feedback h1{font-size:1.5rem;line-height:2.5rem;text-align:center;margin:3rem 0}
`;const C=Object.freeze(Object.defineProperty({__proto__:null,style:_},Symbol.toStringTag,{value:"Module"}));return y}();
