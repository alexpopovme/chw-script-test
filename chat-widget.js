var ChatWidget=function(){"use strict";var W=Object.defineProperty;var Q=(f,m,x)=>m in f?W(f,m,{enumerable:!0,configurable:!0,writable:!0,value:x}):f[m]=x;var a=(f,m,x)=>(Q(f,typeof m!="symbol"?m+"":m,x),x);const f="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciICB2aWV3Qm94PSIwIDAgNTAgNTAiIHdpZHRoPSI1MHB4IiBoZWlnaHQ9IjUwcHgiPjxwYXRoIGQ9Ik0gNy43MTg3NSA2LjI4MTI1IEwgNi4yODEyNSA3LjcxODc1IEwgMjMuNTYyNSAyNSBMIDYuMjgxMjUgNDIuMjgxMjUgTCA3LjcxODc1IDQzLjcxODc1IEwgMjUgMjYuNDM3NSBMIDQyLjI4MTI1IDQzLjcxODc1IEwgNDMuNzE4NzUgNDIuMjgxMjUgTCAyNi40Mzc1IDI1IEwgNDMuNzE4NzUgNy43MTg3NSBMIDQyLjI4MTI1IDYuMjgxMjUgTCAyNSAyMy41NjI1IFoiLz48L3N2Zz4=",m="data:image/png;base64,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",x="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAYAAADimHc4AAAACXBIWXMAAAsTAAALEwEAmpwYAAAC3UlEQVR4nO2cMWgUQRhG30XhBAkWcuCBlQraCAGx8kqxESuxtbSTlJZaWmppJaS0TSW2QRsbQYUUBhshNoGAGk5MVg5m8Lrzcv/ezP7/92D62Xm3u/N27w6EEEIIIYQQQgghhPjHe+A+cFKLUoYmjR3gEXCm0DyILiCPfeA5cL70xKIKyGMMvAKul55gVAHTYwu4A/RKTzaqgDy2gXXgVOlJRxWQxy7wBDhbevJRBeRxAGwAV0ofRFQBeRwCm8DN0gcTVcD0UNgVFqCwq0RAk4bCbkEBL4BfBiLGwEvg6ryfEO/MWrgJg/Sc6JvRWbGlsJtPQKafnpx+NBKxrbCbT0Cml7acm0YidiOH3XEETLOWYuy3gYiDiGG3qIDMufQp3jMQcRgp7KwEZFbTdf2r0eXJfdhZC8ispJ3OOyMRbt/YtSVgmlF6ufPHQIS7sFuGgMzFtHg/DUS4eWO3TAEZhV1hARmFXWEBmdBhV4OA0GFXm4BwYVergDBhV7sA92HXFQFuw66LAlyF3ayJfU43sGfAQ+B22lVM9vC1MAAeA98NRBwBr4Fby/oq5iKT3Us3tckn5ynwIO00hpSh38U3dhYTnUfOBeDEEsPuqPawa0tAM+N6+wV4k751MdmN3AOuAaejhV0JAc0CZ4+7sOuSgGFlAm50VcC4o5egH2m+ly0n6P0m3Hi+CXvfhn5Ix1R0G6oQa5lZAiI9itgo8eXhLgoY6WGcj8fR6y3sutydAat6IVOGYa3h5P0MWKs9nDwK6HUpnDwJ6Kdw+tSlcPIgYKDfnJURcMlDOHVRwMhTOHVFwIrXcKpdgPtwqlVAmHCqTUC4cKpBQOhwKilA4VRIgMKpoAD9XU3LNC2PfW/hZE1bC7/jNZyssV549+FkjcWihwonaxZZ+JDhZM1xFj50OFnj/o1T7fzPwutfDlvE/Run2lE4FUbhVJi3wN0l/GhCCCGEEEIIIYQQQgg88xc8fBUjmiJ1QwAAAABJRU5ErkJggg==",c="FMX22",y="https://dev-api.rnsb.su:843/api",N="wss://dev-api.rnsb.su:843/ws/obj",D=(r,s={})=>{let e=r;return typeof r=="string"&&(e=new URL(r)),new URL(`${e.origin}${e.pathname}?${new URLSearchParams([...Array.from(e.searchParams.entries()),...Object.entries(s)])}`).href},v=r=>{const s=window.localStorage.getItem(`${c}-widget-${r}-data`);return JSON.parse(s)},I=(r,s)=>{for(const[e,t]of Object.entries(r))t===null||typeof t>"u"||(typeof t=="object"&&!Array.isArray(t)?(s[e]=s[e]||{},I(t,s[e])):s[e]=e==="mountPoint"&&typeof t=="string"?document.querySelector(t):t)},B=r=>{if(JSON.parse(window.sessionStorage.getItem(`${c}-widget-${r}-hist`))===null){const e=[document.referrer,window.location.href];window.sessionStorage.setItem(`${c}-widget-${r}-hist`,JSON.stringify(e))}if(!window[c].histTO){const e=()=>{const t=JSON.parse(window.sessionStorage.getItem(`${c}-widget-${r}-hist`))||[],n=t[t.length-1],i=window.location.href;n!==i&&(t.push(i),window.sessionStorage.setItem(`${c}-widget-${r}-hist`,JSON.stringify(t))),window[c].histTO=setTimeout(e,500)};e()}},H=r=>{window.localStorage.removeItem(`${c}-widget-${r}-data`),window.sessionStorage.removeItem(`${c}-widget-${r}-hist`),window.sessionStorage.removeItem(`${c}-widget-${r}-contacts`)},$=r=>{const s=window.sessionStorage.getItem(`${c}-widget-${r}-contacts`);return JSON.parse(s)},C=r=>{const s=JSON.parse(window.sessionStorage.getItem(`${c}-widget-${r}-win-count`))||0,e=JSON.parse(window.localStorage.getItem(`${c}-widget-${r}-win-count`))||0;return{sesCount:s,globCount:e}},j=r=>{const{sesCount:s,globCount:e}=C(r);window.sessionStorage.setItem(`${c}-widget-${r}-win-count`,s+1),window.localStorage.setItem(`${c}-widget-${r}-win-count`,e+1)},R=()=>({handle:"Default",show:{initial:0,on_exit:0,no_action:0,ses_count:1,glob_count:3},text:{h1:"",h2:"",phone_button:"",phone_error:"",feedback:"{{PHONE}}"}}),z=(r,s,e)=>{let t;function n(i){const o=i[0];o.target.dataset.visible=o.isIntersecting.toString(),setTimeout(()=>{e.intersectCb&&e.intersectCb(o,t)},200)}t=new IntersectionObserver(n,{root:r,threshold:.5}),t.observe(s)},P=(r,s)=>{new MutationObserver(t=>{t.forEach(n=>{n.addedNodes.forEach(i=>{i.classList.contains("chat-w-msg-row-send")||z(r,i,s)})})}).observe(r,{childList:!0})},S=r=>new Date(r).toLocaleDateString("ru",{month:"long",day:"numeric"}),J=(r,s)=>S(r)===S(s),k=()=>{const r=document.cookie.match("[sS]*_ym_uid=([^;]*)"),s=document.cookie.match("[sS]*_ga=([^;]*)");return{YM:r?r[1]:null,GA:s?s[1]:null}},E={newChat:()=>`${y}/message/newchat/`,messages:(r,s)=>D(`${y}/message/chat/${r}/messages/`,s),settings:r=>`${y}/core/widget/${r}/`,identity:r=>`${y}/account/identity/${r}/`,lead:r=>`${y}/core/lead/${r}/`,backCall:()=>`${y}/telephony/backcall/`};class G{constructor(s={}){a(this,"response_number","");a(this,"response_email","");a(this,"contact_types",[{name:"phone",text:"Телефон",on_select_text:"Введите Ваш номер телефона",on_end_text:"Вам поступит звонок с номера<br> {{PHONE}}"},{name:"whatsapp",text:"WhatsApp",on_select_text:"Введите Ваш номер WhatsApp",on_end_text:"Вам поступит звонок с номера {{PHONE}}"},{name:"telegram",text:"Telegram",on_select_text:"Введите Ваш номер Телеграм",on_end_text:"Вам поступит звонок с номера {{PHONE}}"},{name:"viber",text:"Viber",on_select_text:"Введите Ваш номер Вайбер",on_end_text:"Вам поступит звонок с номера {{PHONE}}"},{name:"email",text:"Эл. почта",on_select_text:"Введите Вашу электронную почту",on_end_text:"Вам будет отправлено электронное письмо"}]);a(this,"steps",[{text:"На данный момент все операторы заняты, выберите как мы можем с Вами связаться",wait_input:!0,wait_time:0,buttons:null,info:"Выберите как с Вами связаться"},{text:"{{on_select_text}}",wait_input:!0,wait_time:500,buttons:null,info:"{{on_select_text}}"},{text:"Как к Вам обращаться?",wait_input:!0,wait_time:500,buttons:null,info:"Напишите Ваше имя"},{text:"{{on_end_text}}",wait_input:!1,wait_time:500,buttons:null,info:null}]);a(this,"running",!1);a(this,"exitFn",null);a(this,"currStep",-1);a(this,"currHandle",null);a(this,"contacts",{name:void 0,type:void 0,number:void 0});this.response_number=s.response_number,this.response_email=s.response_email,this.contact_types=(s.contact_types||this.contact_types).map(e=>(e.on_end_text=e.on_end_text.replace(/\{\{PHONE}}/g,this.response_number).replace(/\{\{EMAIL}}/g,this.response_email),e)),s.steps&&s.steps.forEach((e,t)=>{e&&(this.steps[t]=e)}),this.steps[0].buttons=this._genContactButtons()}getNextStep(){return this.currStep+=1,this.steps[this.currStep]}stop(){this.running&&this.exitFn&&(this.running=!1,this.exitFn("stopped"),this.exitFn=null)}_genContactButtons(){return this.contact_types.map(s=>({text:s.text,name:s.name}))}}class M{constructor(s,e,t,n){a(this,"settings",null);a(this,"wrapper",null);a(this,"shown",!1);a(this,"noAutoShow",!1);a(this,"_id",null);a(this,"_name",null);a(this,"_visible",!1);a(this,"_closeBtn",null);a(this,"_container",null);a(this,"_phoneInput",null);a(this,"_phoneWarn",null);a(this,"_phoneErr",null);a(this,"_sendPhoneBtn",null);a(this,"_feedbackContainer",null);a(this,"_content",null);a(this,"_root",null);a(this,"_isResWaiting",!1);a(this,"_initialTo",null);a(this,"_setOnExitTO",null);a(this,"_noActionTO",null);const i=this;this._id=n,this._root=s,this._name=e,this.settings=t,this._content={ordercall:`
      <h1>${this.settings.text.h1}</h1>
      <h2>${this.settings.text.h2}</h2>
      <div class="win-w-popup-${this._name}__row">
        <input type="text" placeholder="+7" value="+7">
        <button>${this.settings.text.phone_button}</button>
      </div>
      <div class="win-w-popup-${this._name}__row warn hidden">
         <span>${this.settings.text.phone_error}</span>
      </div>
      <div class="win-w-popup-${this._name}__row err hidden">
         <span></span>
      </div>
    `,promo:`
      <h1>${this.settings.text.h1}</h1>
      <h2>${this.settings.text.h2}</h2>
      <div class="win-w-popup-${this._name}__row">
        <input type="text" placeholder="+7" value="+7">
      </div>
      <div class="win-w-popup-${this._name}__row warn hidden">
         <span>${this.settings.text.phone_error}</span>
      </div>
      <div class="win-w-popup-${this._name}__row err hidden">
         <span></span>
      </div>
      <div class="win-w-popup-${this._name}__row">
         <button>${this.settings.text.phone_button}</button>
      </div>
    `},this._create(),this._closeBtn=this.wrapper.querySelector(".win-w-popup__close"),this._container=this.wrapper.querySelector(`.win-w-popup-${this._name}`),this._feedbackContainer=this.wrapper.querySelector(`.win-w-popup-${this._name}-feedback`),this._sendPhoneBtn=this.wrapper.querySelector("button"),this._phoneInput=this.wrapper.querySelector("input"),this._phoneWarn=this.wrapper.querySelector(`.win-w-popup-${this._name}__row.warn`),this._phoneErr=this.wrapper.querySelector(`.win-w-popup-${this._name}__row.err`),this._sendPhoneBtn.addEventListener("click",()=>{this._backCall(this._phoneInput.value)}),this._phoneInput.addEventListener("keyup",o=>{o.key==="Enter"&&this._backCall(this._phoneInput.value)}),this._phoneInput.addEventListener("focus",()=>{this._phoneWarn.classList.add("hidden"),this._phoneErr.classList.add("hidden")}),this._phoneInput.addEventListener("click",()=>{this._phoneWarn.classList.add("hidden"),this._phoneErr.classList.add("hidden")}),this._phoneInput.addEventListener("input",()=>{this._phoneWarn.classList.add("hidden"),this._phoneErr.classList.add("hidden")}),this._closeBtn.addEventListener("click",()=>{this.hide()}),this._root.addEventListener("backcall-error",o=>{this._isResWaiting=!1,this._visible&&o.detail&&(this._phoneErr.querySelector("span").textContent=o.detail.message||o.detail.err,this._phoneErr.classList.remove("hidden"))}),this.settings.show.no_action>0&&(this._newNoActionTimer(),this._setNoActionReset()),this.settings.show.initial>0&&(this._initialTo=setTimeout(()=>{const{sesCount:o,globCount:h}=C(this._id);this.shown||this.noAutoShow||o>=this.settings.show.ses_count||h>=this.settings.show.glob_count||this.show()},this.settings.show.initial)),this.settings.show.on_exit>0&&(this._setOnExitTO=setTimeout(()=>{const o=()=>{const{sesCount:h,globCount:p}=C(i._id);i.shown||this.noAutoShow||h>=i.settings.show.ses_count||p>=i.settings.show.glob_count||i.show()};document.addEventListener("mouseout",this._newOnExitHandler(o))},this.settings.show.on_exit))}_create(){this.wrapper=document.createElement("div"),this.wrapper.classList.add("win-w-popup-wrap","hidden"),this.wrapper.insertAdjacentHTML("afterbegin",`
           <div class="win-w-popup">
              <div class="win-w-popup__close">
                <img src="${f}" alt="Закрыть">
              </div>
              <div class="win-w-popup-${this._name}">
                 ${this._content[this._name]}
              </div>
              <div class="win-w-popup-${this._name}-feedback"></div>
           </div>
        `)}_checkPhone(s){return/^\+?\d{6,}$/.test(s)}_newOnExitHandler(s){const e=t=>{!t.relatedTarget&&t.clientY<10&&(document.removeEventListener("mouseout",e),s())};return e}_setNoActionReset(){let s=!1;document.addEventListener("touchstart",e=>{s=!0,this._newNoActionTimer()}),document.addEventListener("mousedown",e=>{s||this._newNoActionTimer()}),s=!1}_newNoActionTimer(){const s=this;clearTimeout(s._noActionTO),this._noActionTO=setTimeout(()=>{const{sesCount:e,globCount:t}=C(s._id);this.shown||this.noAutoShow||e>=s.settings.show.ses_count||t>=s.settings.show.glob_count||s.show()},s.settings.show.no_action)}async _backCall(s){const e=this;if(this._checkPhone(s)){if(this._isResWaiting)return;this._isResWaiting=!0,this._root.dispatchEvent(new CustomEvent("backcall",{detail:{phone:s,handle:e.settings.handle,cb(){e._feedbackContainer.innerHTML=`<h1>${e.settings.text.feedback.replace(/{{\s*PHONE\s*}}/ig,s)}</h1>`,e._feedbackContainer.classList.remove("hidden"),e._container.classList.add("hidden"),e._isResWaiting=!1}}}))}else this._phoneWarn.classList.remove("hidden")}hide(){this._visible=!1,this.wrapper.classList.add("hidden"),this._root.dispatchEvent(new CustomEvent("win-hide",{detail:{winName:this._name}}))}show(){this._visible=!0,this.wrapper.classList.remove("hidden"),this.shown=!0,this._root.dispatchEvent(new CustomEvent("win-show",{detail:{winName:this._name}}))}toggle(){this._visible?this.hide():this.show()}}class V{constructor(s,e,t){a(this,"settings",null);a(this,"_root",null);a(this,"_id",null);a(this,"orderCall",null);a(this,"promo",{});this._id=t,this._root=s,this.settings=e,this._create(),this._root.addEventListener("win-show",n=>{j(this._id)})}_create(){this._wrapper=document.createElement("div"),this._wrapper.classList.add("win-w"),this._root.append(this._wrapper),this.settings.order_call&&(this.orderCall=new M(this._root,"ordercall",this.settings.order_call,this._id),this._wrapper.append(this.orderCall.wrapper)),this.settings.promo.length&&this.settings.promo.forEach((s,e)=>{this.promo[s.handle]=new M(this._root,"promo",s,this._id),this._wrapper.append(this.promo[s.handle].wrapper)})}deactAllPhoneWin(){this.orderCall&&(this.orderCall.noAutoShow=!0),this.promo&&(this.promo.noAutoShow=!0)}}class b{constructor(s,e){a(this,"version",null);a(this,"settings",{id:null,data_type:"core__widget",created_at:null,updated_at:null,title:null,site:null,type:0,data:{chat_settings:{mount_point:document.querySelector("#chat-widget"),visible:!1,buttons:[{text:"Узнать статус заказа",command:"get_order_status"}],logo:{src:"",width:"0",height:"0"},text:{header:"Всегда рады ответить на Ваши вопросы!",welcome_message:"Здравствуйте!",input_placeholder:"Напишите что-нибудь"},toggle_button_visible:{initial:!0,show_with_chat:!1,hide_with_chat:!1},initial_show_delay:0,history_limit:20,no_answer_limit:2e4},contact_dialog:{response_number:"8-804-333-08-05",response_email:"email@em.su"},win_settings:{order_call:{handle:"order_call",show:{initial:45e3,on_exit:5e3,no_action:2e4,ses_count:300,glob_count:300},text:{h1:"У Вас остались вопросы?",h2:"Закажите бесплатный обратный звонок",phone_button:"Жду звонка!",phone_error:"Проверьте, что Вы ввели правильный номер!",feedback:"Мы перезвоним Вам в ближайшее время на номер {{PHONE}}"}},promo:[{handle:"demo",show:{initial:0,on_exit:0,no_action:0,ses_count:1,glob_count:3},text:{h1:"10% СКИДКА для всей семьи",h2:"Оставьте свой номер телефона чтобы получить 10% СКИДКУ на поездку для всей семьи!",phone_button:"ПОЛУЧИТЬ СКИДКУ!",phone_error:"Проверьте, что Вы ввели правильный номер!",feedback:"Мы перезвоним Вам в ближайшее время на номер {{PHONE}}"}}]}},source:window[c].chat.source,company:null,hotel:null,operator:null,agent:null});a(this,"extraButtons",null);a(this,"dialog",null);a(this,"_token",null);a(this,"_connecting",!1);a(this,"_chatInitialized",!1);a(this,"_chatShown",!1);a(this,"_chatId",null);a(this,"_messages",[]);a(this,"_messagesProxy",null);a(this,"_sendCB",null);a(this,"_ws",null);a(this,"_root",null);a(this,"_error",{});a(this,"_messageDate",{prev:null,curr:Date.now()});a(this,"_historyEnd",!1);a(this,"_isSenderActive",!1);a(this,"_wrapper",null);a(this,"_inner",null);a(this,"_container",null);a(this,"_chatToggleButton",null);a(this,"_openImg",null);a(this,"_closeImg",null);a(this,"_chatMsgsCont",null);a(this,"_chatInput",null);a(this,"_sendButton",null);a(this,"_errCont",null);a(this,"_buttonsEl",null);a(this,"_lastMsgEl",null);a(this,"_loadingChatHistory",!1);a(this,"_addingChatHistory",!1);a(this,"_chatHistoryOffset",0);a(this,"_chatInitialTO",null);a(this,"_chatAnswerTO",null);a(this,"_chatNoAnswerCbList",[]);a(this,"_win",null);a(this,"_contacts",null);const t=this;this.version="0.0.7",B(s.id);const n=v(s.id);if(n&&n.token&&(this._token=n.token),I(s,t.settings),this.settings.data.win_settings.promo.forEach((i,o)=>{i.handle||(i.handle=`default-promo-handle-${o}`);const h=R();I(i,h),t.settings.data.win_settings.promo[o]=h}),this.extraButtons=e,this._contacts=$(this.settings.id),this._messagesProxy=new Proxy(this._messages,{set(i,o,h){if(o==="length")return!0;if(Array.isArray(h)){i.push(...h.reverse());const p=new DocumentFragment;h.forEach((u,d)=>{const{messageEl:T,dateEl:g}=t._addMessage(u);t._lastMsgEl=T,g&&p.append(g),p.append(t._lastMsgEl)}),t._chatMsgsCont.prepend(p)}else{!i.length&&!t._chatInitialized&&t._chatMsgsCont.prepend(t._createDayRow()),i[o]=h;const{childEl:p}=h,{messageEl:u,dateEl:d}=t._addMessage(h);t._lastMsgEl=u,p&&t._lastMsgEl.append(p),d&&t._chatMsgsCont.append(d),t._chatMsgsCont.append(t._lastMsgEl),t._lastMsgEl.scrollIntoView({behavior:"smooth"})}return!0}}),!this.settings.data.chat_settings.mount_point)throw new Error("ChatWidget: Элемент не найден по селектору указанному в chat_settings.mount_point");this._root=this.settings.data.chat_settings.mount_point.attachShadow({mode:"open"}),Promise.resolve().then(()=>U).then(i=>{this._root.append(i.style),this._create()}),this.settings.data.chat_settings.initial_show_delay>0&&(this._chatInitialTO=setTimeout(()=>{this.show()},this.settings.data.chat_settings.initial_show_delay)),this._chatNoAnswerCbList.push(async()=>{if(v(s.id))try{({}).status!=2&&await t.contactsDialog()}catch(o){this._error.message={title:o.message||o,text:"",orig:o.origError||o,result:o.result}}}),n&&n.chat&&(this._chatId=n.chat,this._setupWS(n),this._chatInitialized=!0),this._win=new V(this._root,this.settings.data.win_settings,this.settings.id),window[c].win=this._win,this._root.addEventListener("backcall",i=>{const{phone:o,handle:h,cb:p}=i.detail;this._backCall(o,h).then(({data:u})=>{this._token||this._updateChatData({token:u}),p&&p()}).catch(u=>{this._root.dispatchEvent(new CustomEvent("backcall-error",{detail:{err:u,message:u.message}}))})}),this._contacts&&this._contacts.number&&this._win.deactAllPhoneWin()}_createDayRow(){const s=this._addDateRow();return s.insertAdjacentHTML("afterbegin",`
              <span>${S(this._messageDate.curr)}</span>
            `),s}_conditionalAddDayRow(){if(!J(this._messageDate.prev,this._messageDate.curr)&&this._messageDate.prev!==null&&new Date(this._messageDate.prev).getTime()<new Date(this._messageDate.curr).getTime())return this._createDayRow()}_addRow(s){const{direction:e,temp:t,data:n}=s,i=document.createElement("div");return i.classList.add("chat-w-msg-row"),n&&n.id&&(i.dataset.id=n.id,i.dataset.read=(n.has_been_read===!0).toString()),e==="send"&&i.classList.add("chat-w-msg-row-send"),t&&i.classList.add("temp"),i}_addDateRow(){const s=document.createElement("div");return s.classList.add("chat-w-date-row"),s}_addMessage(s){const{type:e,data:t}=s;this._messageDate.curr=t.created_at||Date.now();const n=this._conditionalAddDayRow();if(this._messageDate.prev=this._messageDate.curr,e==="text")return{messageEl:this._addTextMessage(s),dateEl:n};if(e==="button")return{messageEl:this._addBtnMessage(s),dateEl:n}}_addTextMessage(s){const{direction:e,text:t,data:n}=s,i=new Date(this._messageDate.curr).toLocaleTimeString(void 0,{timeStyle:"short"}),o=this._addRow(s);return o.insertAdjacentHTML("afterbegin",`
         <p class="chat-w-msg ${e==="send"?"chat-w-msg-send":""}">
           ${t}
           <br>
           <span class="chat-w-msg_time${e==="send"?"_send":""}">${i}</span>
         </p>
        `),o}_addBtnMessage(s){const{direction:e,text:t,data:n}=s,i=new Date(this._messageDate.curr).toLocaleTimeString().slice(0,-3),o=this._addRow(s);return o.insertAdjacentHTML("afterbegin",`
        <span class="chat-w-btn">
          ${t}
        </span>
         <span class="chat-w-btn_time${e==="send"?"_send":""}">${i}</span>
         `),o}_addActionBtn(s,e,t){return s.insertAdjacentHTML("beforeend",`<span class="chat-w-btn-act" data-name="${e}">${t}</span>`),s}_createNoteEl(s){const e=document.createElement("div");return e.classList.add("chat-w-msg-note"),e.insertAdjacentHTML("afterbegin",s),e}_create(){const s=this;this._wrapper=document.createElement("div"),this._wrapper.classList.add("chat-w"),this._inner=document.createElement("div"),this._inner.classList.add("chat-w-inn"),this._inner.insertAdjacentHTML("afterbegin",`
         <div class="chat-w-toggle-btn${this.settings.data.chat_settings.toggle_button_visible.initial?"":" hidden"}">
           <img src="${m}" class="chat-w-open-img" alt="Открыть Чат">
           <img src="${f}" class="chat-w-close-img hidden" alt="Закрыть Чат">
         </div>
    `),this._container=document.createElement("div"),this._container.classList.add("chat-w-cont","chat-w-cont-close"),this._container.insertAdjacentHTML("afterbegin",`
      <div class="chat-w-cont-inn">
        <div class="chat-w-header">
          <div class="chat-w-header-ava-cont">
             ${this.settings.data.chat_settings.logo&&this.settings.data.chat_settings.logo.src?`<img src="${this.settings.data.chat_settings.logo.src}" alt="Лого" style="width:${this.settings.data.chat_settings.logo.width};height:${this.settings.data.chat_settings.logo.height}">`:""}
          </div>
          <span class="chat-w-header-title">${this.settings.data.chat_settings.text.header}</span>
        </div>
        <div class="chat-w-err hidden"><div></div></div>
        <div class="chat-w-msgs invisible"></div>
        <div class="chat-w-btns"></div>
        <div class="chat-w-msg-cont">
           <input type="text" placeholder="${this.settings.data.chat_settings.text.input_placeholder}">
           <div class="chat-w-msg-send-cont">
              <img src="${x}" alt="Отправить сообщение">
           </div>
        </div>
      </div>
    `),this._container.addEventListener("transitionstart",e=>{e.propertyName==="scale"&&this._inner.classList.add("chat-w-cont-transition")}),this._container.addEventListener("transitionend",e=>{e.propertyName==="scale"&&(this._inner.classList.remove("chat-w-cont-transition"),this._chatToggleButton.dataset.chatVisible=`${this.settings.data.chat_settings.visible}`)}),this._inner.append(this._container),this._wrapper.append(this._inner),this._root.append(this._wrapper),this._chatToggleButton=this._wrapper.querySelector(".chat-w-toggle-btn"),this._openImg=this._wrapper.querySelector(".chat-w-open-img"),this._closeImg=this._wrapper.querySelector(".chat-w-close-img"),this._chatMsgsCont=this._wrapper.querySelector(".chat-w-msgs"),this._buttonsEl=this._wrapper.querySelector(".chat-w-btns"),this._sendButton=this._wrapper.querySelector(".chat-w-msg-send-cont"),this._chatInput=this._wrapper.querySelector(".chat-w-msg-cont>input"),this._errCont=this._wrapper.querySelector(".chat-w-err");for(const e of this.settings.data.chat_settings.buttons){const t=document.createElement("span");t.textContent=e.text,t.classList.add("chat-w-btn"),t.addEventListener("click",()=>{this._send(e.text,{command:e.command})}),this._buttonsEl.append(t)}if(this._chatToggleButton.addEventListener("click",()=>{this.toggle()}),this._sendButton.addEventListener("click",()=>{this._send()}),this._chatInput.addEventListener("keyup",e=>{e.key==="Enter"&&this._send()}),Object.defineProperty(this._error,"message",{set(e){e?(s._errCont.innerHTML=`
                    <div>
                      <p>${e.title}</p>
                      <span>${e.text}</span>
                    </div>
                    `,s._errCont.classList.remove("hidden"),e.orig&&console.error(e.orig)):s._errCont.classList.add("hidden")}}),this.settings.data.chat_settings.visible&&this.show(),this.extraButtons){const e=new DocumentFragment;this.extraButtons.forEach(t=>{const n=document.createElement("div");n.classList.add("chat-w-extra-btn"),n.style.backgroundColor=t.color||"unset",n.insertAdjacentHTML("afterbegin",`<img src="${t.imgSrc}" style="${t.imgStyle||""}" alt="${t.title||""}">`),t.action&&n.addEventListener("click",t.action),e.append(n)}),this._inner.append(e)}P(this._chatMsgsCont,{intersectCb:(e,t)=>{s._notifyRead(e,t)}})}_getCurrentURL(){return window.location.href}_updateChatData(s){try{const e=v(this.settings.id);this._token||(this._token=s.token),localStorage.setItem(`${c}-widget-${this.settings.id}-data`,JSON.stringify({...e,...s}))}catch(e){const t=new Error("Ошибка сохранения локальных данных виджета");throw t.origError=e,t}}async _onShowChat(){if(!this._chatShown){const s=v(this.settings.id);let e;if(s&&s.chat){try{e=await this._getMessages(s.chat)}catch(t){this._error.message={title:t.message||t,text:"",orig:t.origError||t,result:t.result};return}this._messagesProxy.push(e),setTimeout(()=>{this._lastMsgEl&&this._lastMsgEl.scrollIntoView(),this._chatMsgsCont.addEventListener("scroll",async()=>{if(this._chatMsgsCont.scrollTop===0&&!this._addingChatHistory){if(this._addingChatHistory=!0,e.length)try{e=await this._getMessages(s.chat)}catch(t){this._error.message={title:t.message||t,text:"",orig:t.origError||t,result:t.result};return}e.length&&(this._lastMsgEl.scrollIntoView(),this._messagesProxy.push(e),this._lastMsgEl.scrollIntoView()),setTimeout(()=>{this._addingChatHistory=!1},300)}else this._chatMsgsCont.scrollTop===0&&this._addingChatHistory&&e.length&&this._lastMsgEl.scrollIntoView()})},100)}else setTimeout(()=>{this._messagesProxy.push({type:"text",direction:"receive",text:this.settings.data.chat_settings.text.welcome_message,data:{}})},800);this._chatShown=!0}setTimeout(()=>{const s=this._chatMsgsCont.querySelector(".chat-w-msg-row:last-of-type");s&&s.scrollIntoView({behavior:"smooth"})},300)}async _initializeChat(s){const e=this;let t={},n;try{n=await this._newChat(s.text)}catch(i){throw this._chatInitialized=!1,i}try{t=this._token?{chat:n.data.chat,lead:n.data.lead}:n.data,this._updateChatData(t),this._chatId=t.chat}catch(i){throw this._chatInitialized=!1,i}await this._setupWS(t),delete s.temp,this._messagesProxy.push(s),this.settings.data.chat_settings.no_answer_limit>0&&(this._chatAnswerTO=setTimeout(()=>{e._chatNoAnswerCbList.forEach(i=>{setTimeout(i,0)})},this.settings.data.chat_settings.no_answer_limit)),this._chatInitialized=!0}async _setupWS(s){this._connecting=!0;try{const e=`${N}/${this._token.key}/`;this._ws=await new WebSocket(e),this._ws.addEventListener("error",()=>{const t=new Error("Соединение не может быть установлено");this._error.message={title:t.message,text:"",orig:null}}),this._ws.addEventListener("message",t=>{const n=JSON.parse(t.data);if(n.type==="message_read"){const{id:o}=n.data,h=this._chatMsgsCont.querySelector(`[data-id="${o}"]`);h&&(h.dataset.read=`${!0}`);return}if(n.type==="chat"&&n.data.sender===this._token.identity){if(this._isSenderActive){const o=this._messagesProxy[this._messagesProxy.length-1];o.data=n.data,delete o.temp,this._lastMsgEl.classList.remove("temp"),this._lastMsgEl.dataset.id=n.data.id,this._isSenderActive=!1}else{const o={type:"text",direction:"send",text:n.data.content,data:n.data};this._messagesProxy.push(o)}return}if(n.type!=="chat"&&!n.data.content)return;const i={type:"text",direction:"receive",text:n.data.content,data:n.data};this._messagesProxy.push(i),clearTimeout(this._chatAnswerTO)}),this._ws.addEventListener("open",()=>{this._ws.send(JSON.stringify({type:"subscribe",data_type:"messaging__chat",object_id:s.chat,window_handler:`chat-${s.chat}-lead-${s.lead}`}))}),this._connecting=!1}catch(e){this._connecting=!1,this._chatInitialized=!1;const t=new Error("Соединение не может быть установлено");throw t.origError=e,t}}async _send(s="",{command:e}={}){const t=this;if(!this._chatInput.value&&!s)return;this._error.message=null,clearTimeout(t._chatAnswerTO),this._isSenderActive=!0;const n=s||this._chatInput.value;let i={},o="text";const h="send",p=!0;this._chatInput.value="",e?(i={content:s,command:e,data_type:"messaging__message"},o="button"):(i={content:n,data_type:"messaging__message"},o="text");const u={type:o,direction:h,text:n,temp:p,data:i};if(this.dialog&&this.dialog.running&&this.dialog.currHandle&&(u.data[this.dialog.currHandle]=u.data.content),this._chatInitialized)try{if(u.data.chat=this._chatId,this._ws.send(JSON.stringify({type:"create_chat_message",data:u.data})),this._ws.readyState!==1)throw new Error("Соединение не установлено");this._messagesProxy.push(u)}catch(d){this._error.message={title:d.message||d,text:"",orig:d.origError||d,result:d.result};return}else try{await this._initializeChat(u)}catch(d){this._error.message={title:d.message||d,text:"",orig:d.origError||d,result:d.result};return}this._sendCB&&this._sendCB(u),t._buttonsEl.classList.add("hidden")}async _newChat(s){let e,t,n;try{e=JSON.stringify({text:s,url:this._getCurrentURL(),widget:this.settings.id,source:this.settings.source,analytics:{widget:this.settings.id,...k(),history:JSON.parse(sessionStorage.getItem(`${c}-widget-${this.settings.id}-hist`))}})}catch(i){const o=new Error("Неправильный формат body для newchat");throw o.origError=i,o}try{t=await fetch(E.newChat(),{method:"POST",headers:{"Content-Type":"application/json;charset=utf-8",Authorization:this._token?this._token.key:window[c].webKey},body:e})}catch(i){const o=new Error("Ошибка при создании чата");throw o.origError=i,o}try{n=await t.json()}catch{const o=new Error("Ошибка при создании чата");throw o.origError=t.statusText,o}if(t.ok)return n;{const i=new Error(JSON.stringify(n));throw i.result=n,i.origError=t.statusText,i}}async _backCall(s,e){let t,n,i;try{t=JSON.stringify({phone:s,url:this._getCurrentURL(),source:this.settings.source,name:this._contacts?this._contacts.name:void 0,analytics:{handle:e,widget:this.settings.id,...k(),history:JSON.parse(sessionStorage.getItem(`${c}-widget-${this.settings.id}-hist`))}})}catch(o){const h=new Error("Неправильный формат body для backCall");throw h.origError=o,h}try{n=await fetch(E.backCall(),{method:"POST",headers:{"Content-Type":"application/json;charset=utf-8",Authorization:this._token?this._token.key:window[c].webKey},body:t})}catch(o){const h=new Error("Ошибка заказа обратного звонка");throw h.origError=o,h}try{i=n.status===204?{}:await n.json()}catch{const h=new Error("Ошибка заказа обратного звонка");throw h.origError=n.statusText,h}if(n.ok)return this._saveContacts({number:s}),i;{const o=new Error(JSON.stringify(i));throw o.result=i,o.origError=n.statusText,o}}async _getLead(s){let e,t;try{e=await fetch(E.lead(s),{method:"GET",headers:{"Content-Type":"application/json;charset=utf-8",Authorization:this._token.key}})}catch(n){throw n}try{t=await e.json()}catch{throw new Error(e.statusText)}if(e.ok)return t.data;{const n=new Error(JSON.stringify(t));throw n.result=t,n.origError=e.statusText,n}}async _getMessages(s){if(this._historyEnd)return[];let e,t;const n={limit:this.settings.data.chat_settings.history_limit,offset:this._chatHistoryOffset};try{e=await fetch(E.messages(s,n),{method:"GET",headers:{"Content-Type":"application/json;charset=utf-8",Authorization:this._token.key}})}catch(i){throw i}try{t=await e.json()}catch{throw new Error(e.statusText)}if(e.ok)return this._historyEnd=t.data.next===null,this._historyEnd&&setTimeout(()=>{this._chatMsgsCont.prepend(this._createDayRow())},100),this._chatHistoryOffset=this._chatHistoryOffset+this.settings.data.chat_settings.history_limit,t.data.results.map(i=>({type:"text",direction:i.sender===this._token.identity?"send":"receive",text:i.content,data:i}));{const i=new Error(JSON.stringify(t));throw i.result=t,i.origError=e.statusText,i}}_notifyRead(s,e){if(this.settings.data.chat_settings.visible!==!1&&s.target.dataset.visible==="true"&&s.target.dataset.read!=="true"){const t=this._messages.find(n=>n.data.id==s.target.dataset.id);t&&t.data.id&&(this._ws.send(JSON.stringify({type:"message_read",data:t.data})),s.target.dataset.read="true",s.target.removeAttribute("data-visible"),e.unobserve(s.target))}}_saveContacts(s){this._contacts={...this._contacts,...s},sessionStorage.setItem(`${c}-widget-${this.settings.id}-contacts`,JSON.stringify(this._contacts)),this._contacts&&this._contacts.number&&this._win.deactAllPhoneWin()}static createWidget(s,e){window[c]=window[c]||{identity:null,webKey:"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9_eyJ0eXBlIjoiYWNjZXNzIiwiaWRlbnRpdHkiOjIsImV4cGlyZWQiOiIyMDI1LTAxLTI1VDA3OjM5OjM1Ljc5NDY0MSswMzowMCIsImlwX2FkZHJlc3MiOiIxMjcuMC4wLjEiLCJzYWx0XzxidWlsdC1pbiBtZXRob2QgcmFuZG9tIG9mIFJhbmRvbSBvYmplY3QgYXQgMHg3ZmJkMjk4Mjg4MTA_IjoiPGJ1aWx0LWluIG1ldGhvZCByYW5kb20gb2YgUmFuZG9tIG9iamVjdCBhdCAweDdmYmQyOTgyODgxMD4ifQ_YmojvoyOVQ_wt1M5wW0m6DGwvDoSoW0NcVx9mxi_ju0",chat:{widget:s,source:e,createChat(){b.getSettings(window[c].chat.widget).then(t=>{window[c].chat=new b(t,window[c].chat.extraButtons)}).catch(t=>{console.error(t.message,`
`,t.origError),window[c].chat=new b({id:window[c].chat.widget,data_type:"core__widget",created_at:"",updated_at:"",title:"default chat widget",site:null,type:0,data:{chat_settings:{buttons:[{text:"Узнать статус заказа",command:"get_order_status"}]}},source:window[c].chat.source,company:1,hotel:null,operator:215,agent:null},window[c].chat.extraButtons),console.log("ChatWidget: Применены настройки по умолчанию")})}}},b.getIdentity(window[c].chat.widget).then(t=>{window[c].identity=t,window[c].chat.createChat()}).catch(t=>{t.response&&t.response.status===401&&(b.clearData(window[c].chat.widget),window[c].chat.createChat())})}static async getSettings(s){const e=window.sessionStorage.getItem(`${c}-widget-${s}-settings`);let t,n;try{if(e)return JSON.parse(e)}catch(i){const o=new Error("Неправильный формат настроек виджета");throw o.origError=i,o}try{t=await fetch(E.settings(s),{method:"GET",headers:{"Content-Type":"application/json;charset=utf-8",Authorization:window[c].webKey}})}catch(i){const o=new Error("Ошибка запроса настроек виджета");throw o.origError=i,o}try{n=await t.json()}catch{const o=new Error("Ошибка запроса настроек виджета");throw o.origError=t.statusText,o}if(t.ok){const i=n?n.data:{};return window.sessionStorage.setItem(`${c}-widget-${s}-settings`,JSON.stringify(i)),i}else{const i=new Error(JSON.stringify(n));throw i.result=n,i.origError=t.statusText,i}}static async getIdentity(s){const e=v(s);if(!e||!e.token||!e.token.identity)return null;let t,n;try{t=await fetch(E.identity(e.token.identity),{method:"GET",headers:{"Content-Type":"application/json;charset=utf-8",Authorization:e.token.key}})}catch(i){const o=new Error("Ошибка запроса identity");throw o.origError=i,o}try{n=await t.json()}catch{const o=new Error("Ошибка запроса identity");throw o.origError=t.statusText,o}if(t.ok)return n?n.data:{};{const i=new Error(JSON.stringify(n));throw i.result=n,i.origError=t.statusText,i.response=t,i}}static clearData(s){H(s)}hide(){this._container.classList.remove("chat-w-cont-open"),this._openImg.classList.remove("hidden"),this._closeImg.classList.add("hidden"),this._container.classList.add("chat-w-cont-close"),this._chatMsgsCont.classList.add("invisible"),this.settings.data.chat_settings.visible=!1,this.settings.data.chat_settings.toggle_button_visible.hide_with_chat&&this._chatToggleButton.classList.add("hidden")}show(){clearTimeout(this._chatInitialTO),this._container.classList.remove("chat-w-cont-close"),this._closeImg.classList.remove("hidden"),this._openImg.classList.add("hidden"),this._container.classList.add("chat-w-cont-open"),this._chatMsgsCont.classList.remove("invisible"),this.settings.data.chat_settings.toggle_button_visible.show_with_chat&&this._chatToggleButton.classList.remove("hidden"),this.settings.data.chat_settings.visible=!0,this._onShowChat()}toggle(){this.settings.data.chat_settings.visible?this.hide():this.show()}async contactsDialog(s){const e=this,t=new G(s||e.settings.data.contact_dialog);this.dialog=t;const n=t.getNextStep(),i=()=>new Promise((g,L)=>{t.exitFn=g,clearTimeout(e._chatAnswerTO),setTimeout(()=>{if(this._messagesProxy.push({type:"text",direction:"receive",text:n.text,data:{}}),n.buttons){const w=e._addRow({direction:"receive"}),_=document.createElement("div");_.classList.add("chat-w-msg-row__cont"),n.buttons.forEach(l=>{e._addActionBtn(_,l.name,l.text)}),w.append(_),e._chatMsgsCont.append(w),w.scrollIntoView({behavior:"smooth"}),w.addEventListener("click",l=>{t.contacts.type=l.target.dataset.name,e._chatInput.value=l.target.textContent,t.currHandle="CONTACT_TYPE",e._send(),w.classList.add("inactive")})}n.wait_input?(n.info&&(e._chatInput.placeholder=n.info),e._sendCB=()=>{e._sendCB=null,t.currHandle=null,g()}):g()},n.wait_time)}),o=t.getNextStep(),h=()=>new Promise((g,L)=>{t.exitFn=g,t.currHandle="CONTACT_NUMBER",clearTimeout(e._chatAnswerTO),setTimeout(()=>{let w,_;if(o.text.includes("{{on_select_text}}")){const l=t.contact_types.find(A=>A.name===t.contacts.type);if(!l)return t.stop(),g();w=o.text.replace("{{on_select_text}}",l.on_select_text),_=o.info.replace("{{on_select_text}}",l.on_select_text)}else w=o.text,_=o.info;this._messagesProxy.push({type:"text",direction:"receive",text:w,data:{}}),o.wait_input?(o.info&&(e._chatInput.placeholder=_),e._sendCB=l=>{t.contacts.number=l.data.content,e._sendCB=null,t.currHandle=null,g()}):g()},o.wait_time)}),p=t.getNextStep(),u=()=>new Promise((g,L)=>{t.exitFn=g,t.currHandle="NAME",clearTimeout(e._chatAnswerTO),setTimeout(()=>{this._messagesProxy.push({type:"text",direction:"receive",text:p.text,data:{}}),p.wait_input?(p.info&&(e._chatInput.placeholder=p.info),e._sendCB=w=>{t.contacts.name=w.data.content,e._sendCB=null,t.currHandle=null,g()}):g()},p.wait_time)}),d=t.getNextStep(),T=()=>new Promise((g,L)=>{t.exitFn=g,clearTimeout(e._chatAnswerTO),setTimeout(()=>{let w;if(d.text.includes("{{on_end_text}}")){const l=t.contact_types.find(A=>A.name===t.contacts.type);if(!l)return t.stop(),g();w=d.text.replace("{{on_end_text}}",l.on_end_text)}else w=d.text;const _=e._createNoteEl('<span class="link">Изменить контактные данные</span>');_.addEventListener("click",()=>{e.dialog&&e.dialog.stop();const l=JSON.parse(JSON.stringify(e.settings.data.contact_dialog))||{},A={text:"Выберите как мы можем с Вами связаться",wait_input:!0,wait_time:0,buttons:null,info:"Выберите как с Вами связаться"};l.steps=l.steps||[],l.steps[0]?l.steps[0].text="Выберите как мы можем с Вами связаться":l.steps.push(A),e.contactsDialog(l)}),this._messagesProxy.push({type:"text",direction:"receive",text:w,data:{},childEl:_}),g()},d.wait_time)});t.running=!0,t.running&&await i(),t.running&&await h(),t.running&&await u(),t.running&&await T(),this._saveContacts(t.contacts),e._chatInput.placeholder=e.settings.data.chat_settings.text.input_placeholder,t.running=!1,this.dialog=null}}const O=document.createElement("style");O.textContent=`@charset "UTF-8";.win-w *{box-sizing:border-box;line-height:16px;font-size:15px;font-family:Arial,Helvetica,sans-serif}.win-w-popup-wrap{position:fixed;top:0;left:0;right:0;bottom:0;display:flex;justify-content:center;align-items:center;margin:auto;background-color:#00000054;z-index:10000000000}.win-w-popup{width:700px;min-height:345px;height:fit-content;background-color:#fff;border-radius:10px;box-sizing:border-box;padding:40px 20px 20px;position:relative}.win-w-popup__close{position:absolute;top:15px;right:15px;width:20px;height:20px;cursor:pointer;z-index:1}.win-w-popup__close img{width:100%;height:auto}.win-w-popup-ordercall{color:#333;font-family:Arial,Helvetica,sans-serif;font-size:15px}.win-w-popup-ordercall h1{font-size:28px;line-height:30px;text-align:center}.win-w-popup-ordercall h2{font-size:22px;line-height:24px;text-align:center}.win-w-popup-ordercall__row{display:flex;justify-content:center;align-items:flex-end;flex-wrap:wrap}.win-w-popup-ordercall input{display:inline-block;border-radius:8px;padding:6px 15px;margin-bottom:10px;font-size:18px;font-style:italic;color:#333;border:2px solid #ccc;background-color:#fff;height:52px;width:250px;top:2px;box-sizing:border-box}.win-w-popup-ordercall input:focus{outline:unset!important;border-color:#1e90ff}.win-w-popup-ordercall input:focus-visible{outline:unset!important;border-color:#1e90ff}.win-w-popup-ordercall button{height:52px;padding:10px 30px;margin-bottom:10px;margin-left:10px;border-radius:8px;color:#fff;border-color:#ff8f1f;font-size:20px;line-height:20px;font-weight:700;box-sizing:border-box;cursor:pointer;background-color:#ff8f1f;user-select:none;box-shadow:0 4px 8px #333333a6;transition:all .1s ease}.win-w-popup-ordercall button:active{box-shadow:0 2px 4px #333333a6;transform:scale(.98)}.win-w-popup-ordercall-feedback{color:#333;font-family:Arial,Helvetica,sans-serif;display:flex;justify-content:center;align-items:center}.win-w-popup-ordercall-feedback h1{font-size:24px;line-height:40px;text-align:center;margin:48px 0}.win-w-popup-promo{padding:0 64px}.win-w-popup-promo h1{font-size:32px;line-height:36px;text-align:center;color:#1e90ff}.win-w-popup-promo h2{font-size:18px;line-height:20px;text-align:center;color:#4a4a4a}.win-w-popup-promo input{display:inline-block;font-size:22px;color:#4a4a4a;border-width:0 0 2px 0;border-style:solid;border-color:#ccc;background-color:#fff;text-align:center;width:250px;box-sizing:border-box}.win-w-popup-promo input:focus{outline:unset!important;border-color:#1e90ff}.win-w-popup-promo input:focus-visible{outline:unset!important;border-color:#1e90ff}.win-w-popup-promo__row{display:flex;justify-content:center;align-items:flex-end;padding:30px 0}.win-w-popup-promo__row.warn,.win-w-popup-promo__row.err{padding:0}.win-w-popup-promo button{width:250px;box-sizing:border-box;padding:15px;background:none;border:3px solid dodgerblue;border-radius:3px;font-size:19px;line-height:20px;font-weight:700;color:#1e90ff;cursor:pointer;transition:all .1s ease;margin-bottom:16px}.win-w-popup-promo button:hover{box-shadow:0 4px 8px #333333a6;background-color:#1e90ff;color:#fff}.win-w-popup-promo button:active{box-shadow:0 2px 4px #333333a6;transform:scale(.98)}.win-w-popup-promo-feedback{color:#333;font-family:Arial,Helvetica,sans-serif;display:flex;justify-content:center;align-items:center}.win-w-popup-promo-feedback h1{font-size:24px;line-height:40px;text-align:center;margin:48px 0}.warn{color:#ff8f1f}.chat-w{position:fixed;bottom:10px;right:10px;z-index:2147483647}.chat-w *{box-sizing:border-box;line-height:16px;font-size:15px;font-family:Arial,Helvetica,sans-serif}.chat-w-inn{position:relative;display:flex;justify-content:flex-end;flex-direction:row-reverse;gap:8px}.chat-w-toggle-btn{width:80px;height:80px;border-radius:40px;background-color:#1e90ff;cursor:pointer;display:flex;justify-content:center;align-items:center;user-select:none}.chat-w-toggle-btn img{width:65%;filter:invert(1)}.chat-w-toggle-btn img.chat-w-close-img{width:55%}.chat-w-extra-btn{width:80px;height:80px;border-radius:40px;cursor:pointer;display:flex;justify-content:center;align-items:center;user-select:none}.chat-w-cont{width:400px;height:720px;position:absolute;bottom:100px;right:10px;transform-origin:bottom right}.chat-w-cont-open{transition:scale .3s ease-out,opacity .5s ease .1s;opacity:1;scale:1}.chat-w-cont-close{transition:scale .5s ease-in,opacity .3s ease;opacity:0;scale:0}.chat-w-cont-inn{width:100%;height:100%;display:flex;flex-direction:column;border-radius:4px;box-shadow:0 6px 6px #00000005,0 8px 24px #0000001f;background:white}.chat-w-header{width:100%;min-height:20%;flex-shrink:0;background-color:#1e90ff;border-radius:4px 4px 0 0;display:flex;flex-direction:column;justify-content:center;align-items:center}.chat-w-header-ava-cont{display:flex}.chat-w-header-title{font-weight:700;color:#fff;padding:13px 0}.chat-w-msgs{flex-grow:1;padding:15px;display:flex;flex-direction:column;gap:14px;overflow:auto;background-color:#fff;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='12' viewBox='0 0 20 12'%3E%3Cg fill-rule='evenodd'%3E%3Cg id='charlie-brown' fill='%2391d0f5' fill-opacity='0.24'%3E%3Cpath d='M9.8 12L0 2.2V.8l10 10 10-10v1.4L10.2 12h-.4zm-4 0L0 6.2V4.8L7.2 12H5.8zm8.4 0L20 6.2V4.8L12.8 12h1.4zM9.8 0l.2.2.2-.2h-.4zm-4 0L10 4.2 14.2 0h-1.4L10 2.8 7.2 0H5.8z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");transition:opacity .3s ease .35s}.chat-w-btns{padding:15px 15px 0;display:flex;gap:8px;flex-shrink:0;flex-wrap:wrap}.chat-w-msg-send-cont{height:100%;width:40px;cursor:pointer;display:flex;justify-content:center;align-items:center}.chat-w-msg-send-cont img{width:100%;filter:invert(50%) sepia(100%) hue-rotate(180deg) saturate(300%)}.chat-w-msg{max-width:75%;margin:0;padding:10px;background-color:#e3e4e9;color:#212b36;box-shadow:1px 1px 2px #aaa;border-radius:12px}.chat-w-msg-send{background-color:#4a85dd;color:#fff}.chat-w-msg-cont{display:flex;align-items:center;flex-shrink:0;gap:7.5px;padding:7.5px;height:60px}.chat-w-msg-cont input{width:100%;height:80%;border:1px solid #d8dcde;border-radius:20px;padding-left:15px;color:#212b36}.chat-w-msg-cont input:focus{outline:unset!important;border-color:#1e90ff}.chat-w-msg-cont input:focus-visible{outline:unset!important;border-color:#1e90ff}.chat-w-msg-row{display:flex;align-items:flex-start;flex-direction:column;transition:opacity ease .2s}.chat-w-msg-row-send{align-items:flex-end}.chat-w-msg-row-send .chat-w-btn{pointer-events:none;max-width:75%}.chat-w-msg-row__cont{display:flex;flex-wrap:wrap;gap:16px}.chat-w-msg-note{padding:0 10px;margin-top:3px}.chat-w-msg-note .link{font-size:13px}.chat-w-msg_time,.chat-w-btn_time_send,.chat-w-btn_time,.chat-w-msg_time_send{display:inline-block;width:100%;position:relative;left:-3px;bottom:-5px;color:#212b3680;font-size:13px}.chat-w-msg_time_send{text-align:right;left:unset;right:-3px;color:#e3e4e9cc}.chat-w-btn{color:#36c;background:rgba(255,255,255,.6);padding:9px 14px;border-radius:18px;border:1px solid #3366CC;display:inline-block;cursor:pointer;flex-shrink:0;user-select:none}.chat-w-btn:hover{color:#1e90ff;border-color:#1e90ff}.chat-w-btn_time_send{text-align:right;left:unset;right:-3px}.chat-w-btn-act{color:#36c;background:#e3e4e9;padding:9px 14px;border-radius:8px;display:inline-block;cursor:pointer;flex-shrink:0;user-select:none;box-shadow:0 2px 4px #33333373;transition:all .15s ease}.chat-w-btn-act:hover{color:#fff;background:dodgerblue;box-shadow:0 3px 6px #3333338c}.chat-w-err{display:flex;align-items:center;background-color:#f801261a;margin:15px;border-radius:4px}.chat-w-err:before{content:"!";display:flex;justify-content:center;align-items:center;flex-shrink:0;margin:15px;color:#fff;font-weight:700;font-size:18px;width:30px;height:30px;border-radius:15px;background-color:#f80126e6}.chat-w-err div{height:100%;font-size:13px;display:flex;flex-direction:column;justify-content:center}.chat-w-err p{margin:0;padding:4px 0;font-weight:700;color:#f80126e6;text-align:left}.chat-w-err span{display:block;line-height:13px}.chat-w-date-row{display:flex;justify-content:center;align-items:center}.chat-w-date-row span{padding:13px 15px;border-radius:24px;background:rgba(33,43,54,.5);color:#fff}.link{color:#36c;text-decoration:none;cursor:pointer}.link:hover{text-decoration:underline}.hidden{display:none!important}.invisible{opacity:0}.inactive{pointer-events:none}.err{color:red}.temp{opacity:.6}[data-read=true] .chat-w-msg_time_send:after,[data-read=true] .chat-w-btn_time_send:after{position:relative;bottom:-2px;content:"✓✓  ";padding:0 12px 0 6px;font-size:18px;letter-spacing:-22px}@media (max-height: 850px){.chat-w-cont{height:84vh}}@media (max-width: 680px) and (orientation: portrait),(max-height: 720px) and (orientation: landscape){.chat-w-cont{position:fixed;right:0;bottom:0;width:100vw;height:100vh;z-index:100000}.chat-w-cont-transition .chat-w-toggle-btn{opacity:0}.chat-w-header{border-radius:0}.chat-w-toggle-btn[data-chat-visible=true]{position:fixed;top:0;right:0;z-index:100001;background:none;width:56px;height:56px}}
`;const U=Object.freeze(Object.defineProperty({__proto__:null,style:O},Symbol.toStringTag,{value:"Module"}));return b}();
